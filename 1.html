<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üîç –ú–£–ó–ï–ô–ù–ê–Ø –¢–ê–ô–ù–ê | –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫—Ä–∞–∂–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        :root {
            --museum-gold: #d4af37;
            --museum-dark: #0f0f0f;
            --museum-red: #8b0000;
            --museum-ink: #1a1a2e;
            --museum-paper: #f5f5dc;
        }
        
        body {
            font-family: 'Crimson Text', serif;
            background: var(--museum-dark);
            color: #e8e6e3;
            overflow-x: hidden;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .font-title { font-family: 'Cinzel', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .bg-museum {
            background-image: linear-gradient(rgba(15, 15, 26, 0.85), rgba(15, 15, 26, 0.9)), url('https://images.unsplash.com/photo-1603750003385-3342231a1ff1?fm=jpg&q=60&w=3000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }
        
        .case-file {
            background: linear-gradient(145deg, #f5f5dc 0%, #e8e8d0 100%);
            color: #1a1a2e;
            border: 3px solid var(--museum-gold);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        
        .case-file::before {
            content: '–°–û–í–ï–†–®–ï–ù–ù–û –°–ï–ö–†–ï–¢–ù–û';
            position: absolute;
            top: 25px;
            right: -25px;
            background: var(--museum-red);
            color: white;
            padding: 4px 30px;
            font-size: 9px;
            font-weight: bold;
            letter-spacing: 2px;
            transform: rotate(45deg);
            opacity: 0.8;
            font-family: 'Cinzel', serif;
            pointer-events: none;
            white-space: nowrap;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 200px;
            text-overflow: ellipsis;
        }
        
        .evidence-locked {
            filter: grayscale(100%) brightness(0.4) contrast(1.2);
            pointer-events: none;
            opacity: 0.5;
        }
        
        .evidence-active {
            animation: pulse-gold 2s infinite;
            cursor: pointer;
            position: relative;
        }
        
        .evidence-active::after {
            content: '‚ñ∂ –û–¢–ö–†–´–¢–¨';
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--museum-red);
            color: white;
            padding: 5px 15px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            animation: blink 1s infinite;
            white-space: nowrap;
            z-index: 5;
        }
        
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212,175,55,0.4); }
            50% { box-shadow: 0 0 30px 10px rgba(212,175,55,0.2); }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .word-grid-20x20 {
            display: grid;
            grid-template-columns: repeat(20, minmax(22px, 1fr));
            gap: 1px;
            max-width: 100%;
            margin: 0 auto;
            background: #1a1a2e;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid var(--museum-gold);
            position: relative;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .grid-cell-20x20 {
            aspect-ratio: 1;
            background: #2a2a3e;
            border: 1px solid var(--museum-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: var(--museum-gold);
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.15s;
            font-family: 'JetBrains Mono', monospace;
            position: relative;
            z-index: 2;
        }
        
        .grid-cell-20x20.selected {
            background: var(--museum-gold);
            color: #1a1a2e;
            transform: scale(1.1);
            z-index: 3;
            box-shadow: 0 0 10px rgba(212,175,55,0.5);
        }
        
        .grid-cell-20x20.in-word {
            background: #4ade80;
            color: #1a1a2e;
            border-color: #22c55e;
        }
        
        .word-line-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .word-line {
            stroke: var(--museum-gold);
            stroke-width: 3;
            stroke-linecap: round;
            fill: none;
            filter: drop-shadow(0 0 3px rgba(212,175,55,0.8));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .word-line.show {
            opacity: 1;
        }
        
        .selected-word-20x20 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            letter-spacing: 4px;
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            min-height: 50px;
            word-break: break-all;
            color: var(--museum-gold);
        }
        
        .word-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            max-width: 400px;
            margin: 0 auto;
            background: #1a1a2e;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--museum-gold);
            position: relative;
        }
        
        .grid-cell {
            aspect-ratio: 1;
            background: #2a2a3e;
            border: 1px solid var(--museum-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--museum-gold);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
            position: relative;
            z-index: 2;
        }
        
        .grid-cell.selected {
            background: var(--museum-gold);
            color: #1a1a2e;
            transform: scale(1.05);
        }
        
        .grid-cell.in-word {
            background: #4ade80;
            color: #1a1a2e;
            border-color: #22c55e;
        }
        
        .phase-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .phase-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1a1a2e;
            border: 2px solid var(--museum-gold);
            color: var(--museum-gold);
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .phase-btn.active {
            background: var(--museum-gold);
            color: #1a1a2e;
            transform: scale(1.1);
        }
        
        .phase-btn.completed {
            background: #4ade80;
            border-color: #22c55e;
            color: #1a1a2e;
        }
        
        .phase-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .phase-btn.locked {
            opacity: 0.3;
            cursor: not-allowed;
            position: relative;
        }
        
        .phase-btn.locked::after {
            content: 'üîí';
            position: absolute;
            font-size: 12px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .btn-detective {
            background: linear-gradient(135deg, var(--museum-gold), #b8941f);
            color: #1a1a2e;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            padding: 16px 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .btn-detective:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-detective:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212,175,55,0.3);
        }
        
        .btn-secondary-detective {
            background: transparent;
            color: var(--museum-gold);
            border: 2px solid var(--museum-gold);
            font-family: 'Cinzel', serif;
            padding: 14px 30px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-secondary-detective:hover {
            background: var(--museum-gold);
            color: #1a1a2e;
        }
        
        .detective-input {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            text-align: center;
            border: 2px solid var(--museum-gold);
            background: white;
            padding: 12px;
            border-radius: 4px;
            width: 100%;
            color: #1a1a2e;
        }
        
        .team-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--museum-gold);
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
        }
        
        .investigation-progress {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .investigation-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--museum-gold), var(--museum-red));
            transition: width 0.5s ease;
        }
        
        .modal-overlay {
            background: rgba(15,15,26,0.98);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 200;
        }
        
        .stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            border: 4px solid var(--museum-red);
            color: var(--museum-red);
            padding: 10px 20px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 4px;
            opacity: 0;
            pointer-events: none;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(2px);
            border-radius: 4px;
            white-space: nowrap;
            max-width: 90%;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        .stamp.show {
            opacity: 0.85;
            animation: stamp-in 0.4s ease-out;
        }
        
        @keyframes stamp-in {
            0% { transform: translate(-50%, -50%) rotate(-15deg) scale(2); opacity: 0; }
            100% { transform: translate(-50%, -50%) rotate(-15deg) scale(1); opacity: 0.85; }
        }
        
        .conn-status {
            position: fixed;
            top: 10px; right: 10px;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            z-index: 10000;
            backdrop-filter: blur(10px);
            border: 1px solid;
        }
        
        .conn-online { background: rgba(74,222,128,0.1); color: #4ade80; border-color: #4ade80; }
        .conn-offline { background: rgba(248,113,113,0.1); color: #f87171; border-color: #f87171; }
        .conn-connecting { background: rgba(251,191,36,0.1); color: #fbbf24; border-color: #fbbf24; }
        
        .riddle-box {
            font-family: 'Crimson Text', serif;
            font-size: 18px;
            background: #f5f5dc;
            color: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #d4af37;
            font-style: italic;
        }
        
        .player-role {
            display: inline-block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--museum-gold);
            color: #1a1a2e;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .qr-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .qr-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--museum-gold);
            page-break-inside: avoid;
        }
        
        .qr-code-container {
            width: 150px;
            height: 150px;
            margin: 0 auto 10px;
        }
        
        .qr-code-container img {
            width: 100% !important;
            height: 100% !important;
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }
        
        .scroll-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        .card-completed {
            opacity: 0.8;
        }

        #qr-reader {
            width: 100%;
            max-width: 500px;
            border: 2px solid var(--museum-gold);
            border-radius: 8px;
            overflow: hidden;
        }

        #qr-reader video {
            width: 100%;
            height: auto;
        }

        #qr-reader__scan_region {
            background: white;
        }

        #qr-reader__dashboard {
            padding: 10px;
            background: rgba(255,255,255,0.1);
        }

        #qr-reader__dashboard button {
            background: var(--museum-gold);
            color: #1a1a2e;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            margin: 5px;
        }

        #qr-reader__status_span {
            color: var(--museum-gold);
        }

        #qr-reader__header_message {
            color: var(--museum-gold);
        }

        .anagram-tile {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #d4af37, #b8941f);
            border: 2px solid #1a1a2e;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: bold;
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .anagram-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212,175,55,0.4);
        }

        .anagram-tile.used {
            opacity: 0.3;
            pointer-events: none;
            transform: scale(0.9);
        }

        .anagram-tile.selected {
            background: #4ade80;
            border-color: #22c55e;
        }

        .hidden-answer {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
            opacity: 0.5;
            transition: filter 0.3s;
        }

        .hidden-answer.revealed {
            filter: blur(0);
            opacity: 1;
            pointer-events: auto;
        }

        .puzzle-piece {
            width: 80px;
            height: 80px;
            background: #1a1a2e;
            border: 3px solid var(--museum-gold);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--museum-gold);
            cursor: pointer;
            transition: transform 0.3s;
            margin: 0 auto;
        }

        .puzzle-piece:hover {
            transform: scale(1.05);
        }

        @media (max-width: 640px) {
            .word-grid-20x20 {
                grid-template-columns: repeat(20, minmax(16px, 1fr));
                gap: 0.5px;
                padding: 4px;
            }
            
            .grid-cell-20x20 {
                font-size: 9px;
            }
            
            .selected-word-20x20 {
                font-size: 18px;
                letter-spacing: 2px;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-museum" id="body-bg">

    <div id="conn-status" class="conn-status conn-connecting">‚ö° –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...</div>

    <!-- MODE SELECT -->
    <div id="mode-select" class="min-h-screen flex flex-col items-center justify-center p-4 relative z-10">
        <div class="text-center mb-12">
            <div class="mb-6">
                <svg width="120" height="120" viewBox="0 0 120 120" class="mx-auto">
                    <circle cx="60" cy="60" r="55" fill="none" stroke="#d4af37" stroke-width="3"/>
                    <path d="M60,20 L60,60 L85,85" fill="none" stroke="#d4af37" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="60" cy="60" r="8" fill="#d4af37"/>
                    <rect x="35" y="35" width="50" height="50" fill="none" stroke="#8b0000" stroke-width="2" transform="rotate(15 60 60)"/>
                </svg>
            </div>
            <h1 class="text-5xl md:text-6xl font-title font-black mb-4 text-[#d4af37] tracking-widest">
                –ú–£–ó–ï–ô–ù–ê–Ø<br>–¢–ê–ô–ù–ê
            </h1>
            <p class="text-xl text-gray-400 italic mb-2">"–ö—Ä–∞–∂–∞ –≤–µ–∫–∞ –≤ –ì–∞–ª–µ—Ä–µ–µ –ò—Å–∫—É—Å—Å—Ç–≤"</p>
            <div class="w-32 h-1 bg-[#d4af37] mx-auto mt-6"></div>
        </div>
        
        <div class="w-full max-w-lg bg-black/40 backdrop-blur rounded-lg p-8 border border-[#d4af37]/30 mb-8">
            <div class="text-sm text-[#d4af37] mb-4 flex items-center gap-2 font-mono uppercase tracking-widest">
                <span>‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–∏:
            </div>
            <textarea id="fb-config" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'
                      class="w-full h-32 bg-black/60 rounded p-4 text-xs font-mono text-[#4ade80] border border-[#d4af37]/30 focus:border-[#d4af37] focus:outline-none resize-none"></textarea>
            <button onclick="saveConfig()" class="mt-4 w-full btn-detective">
                üì° –£–°–¢–ê–ù–û–í–ò–¢–¨ –°–í–Ø–ó–¨
            </button>
            <div id="config-ok" class="hidden mt-3 text-center text-[#4ade80] text-sm font-mono">‚úÖ –°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>
        </div>
        
        <div class="w-full max-w-md space-y-4">
            <button onclick="startMode('teacher')" class="w-full group relative overflow-hidden bg-gradient-to-br from-[#1a1a2e] to-[#0f0f1a] rounded-lg p-8 border-2 border-[#d4af37]/50 transition-all hover:border-[#d4af37]">
                <div class="relative flex items-center gap-6">
                    <div class="text-5xl">üïµÔ∏è</div>
                    <div class="text-left">
                        <div class="text-2xl font-title font-bold text-[#d4af37] mb-1">–ì–õ–ê–í–ù–´–ô –°–õ–ï–î–û–í–ê–¢–ï–õ–¨</div>
                        <div class="text-sm text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º</div>
                    </div>
                </div>
            </button>
            
            <button onclick="startMode('team')" class="w-full group relative overflow-hidden bg-gradient-to-br from-[#2e1616] to-[#1a0a0a] rounded-lg p-8 border-2 border-[#d4af37]/50 transition-all hover:border-[#d4af37]">
                <div class="relative flex items-center gap-6">
                    <div class="text-5xl">üëÆ</div>
                    <div class="text-left">
                        <div class="text-2xl font-title font-bold text-[#d4af37] mb-1">–û–ü–ï–†–ê–¢–ò–í–ù–ê–Ø –ì–†–£–ü–ü–ê</div>
                        <div class="text-sm text-gray-400">4 –∞–≥–µ–Ω—Ç–∞ ‚Ä¢ 1 –¥–µ–ª–æ</div>
                    </div>
                </div>
            </button>
        </div>
    </div>

    <!-- TEACHER PANEL -->
    <div id="teacher-panel" class="hidden min-h-screen p-4 pb-32 relative z-10">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8 border-b border-[#d4af37]/30 pb-4">
                <div class="flex items-center gap-4">
                    <div class="text-4xl">üïµÔ∏è</div>
                    <div>
                        <h2 class="text-3xl font-title font-bold text-[#d4af37]">–¶–ï–ù–¢–† –£–ü–†–ê–í–õ–ï–ù–ò–Ø</h2>
                        <p class="text-sm text-gray-400 font-mono">–î–µ–ª–æ: –ö—Ä–∞–∂–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞</p>
                    </div>
                </div>
                <button onclick="location.reload()" class="btn-secondary-detective text-sm">
                    –ó–ê–ö–†–´–¢–¨ –î–ï–õ–û
                </button>
            </div>
            
            <div class="case-file rounded-lg p-8 mb-8 relative">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div class="text-xs font-bold text-[#8b0000] uppercase tracking-widest mb-2">–ù–æ–º–µ—Ä –¥–µ–ª–∞</div>
                        <div class="text-6xl font-mono font-bold text-[#1a1a2e] tracking-widest mb-4" id="room-code">----</div>
                        <div class="flex gap-3">
                            <button onclick="createRoom()" class="flex-1 bg-[#1a1a2e] text-[#d4af37] py-3 rounded font-bold text-sm hover:bg-[#2a2a3e] transition">
                                üìù –ù–û–í–û–ï –î–ï–õ–û
                            </button>
                            <button onclick="deleteRoom()" class="flex-1 bg-[#8b0000] text-white py-3 rounded font-bold text-sm hover:bg-[#a03040] transition">
                                üóëÔ∏è –£–î–ê–õ–ò–¢–¨
                            </button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-[#1a1a2e]/5 p-4 rounded border border-[#1a1a2e]/10">
                            <div class="text-xs text-[#1a1a2e]/60 uppercase mb-1">–ì—Ä—É–ø–ø –≤ –¥–µ–ª–µ</div>
                            <div class="text-3xl font-bold text-[#1a1a2e]" id="stat-teams">0</div>
                        </div>
                        <div class="bg-[#1a1a2e]/5 p-4 rounded border border-[#1a1a2e]/10">
                            <div class="text-xs text-[#1a1a2e]/60 uppercase mb-1">–≠—Ç–∞–ø —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</div>
                            <div class="text-3xl font-bold text-[#1a1a2e]" id="stat-phase">0/5</div>
                        </div>
                        <div class="bg-[#1a1a2e]/5 p-4 rounded border border-[#1a1a2e]/10">
                            <div class="text-xs text-[#1a1a2e]/60 uppercase mb-1">–í—Ä–µ–º—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è</div>
                            <div class="text-3xl font-mono font-bold text-[#8b0000]" id="stat-time">20:00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="startGame()" id="btn-start" class="w-full mb-8 btn-detective opacity-50 cursor-not-allowed" disabled>
                üîç –ù–ê–ß–ê–¢–¨ –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï
            </button>
            
            <div class="bg-black/40 rounded-lg p-6 border border-[#d4af37]/30">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-title font-bold text-[#d4af37]">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã</h3>
                    <span class="flex items-center gap-2 text-xs text-[#4ade80] font-mono">
                        <span class="w-2 h-2 bg-[#4ade80] rounded-full animate-pulse"></span> LIVE
                    </span>
                </div>
                <div id="teams-list" class="space-y-3">
                    <div class="text-center text-gray-500 py-8 italic">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≥—Ä—É–ø–ø...</div>
                </div>
            </div>
            
            <div class="mt-8 bg-black/40 rounded-lg p-6 border border-[#d4af37]/30">
                <div class="text-sm text-[#d4af37] mb-4 font-mono uppercase tracking-widest">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥:</div>
                <div class="grid grid-cols-5 gap-3">
                    <button onclick="forcePhase(1)" class="bg-[#1a1a2e] border border-[#d4af37]/50 text-[#d4af37] py-4 rounded font-bold hover:bg-[#d4af37] hover:text-[#1a1a2e] transition">I</button>
                    <button onclick="forcePhase(2)" class="bg-[#1a1a2e] border border-[#d4af37]/50 text-[#d4af37] py-4 rounded font-bold hover:bg-[#d4af37] hover:text-[#1a1a2e] transition">II</button>
                    <button onclick="forcePhase(3)" class="bg-[#1a1a2e] border border-[#d4af37]/50 text-[#d4af37] py-4 rounded font-bold hover:bg-[#d4af37] hover:text-[#1a1a2e] transition">III</button>
                    <button onclick="forcePhase(4)" class="bg-[#1a1a2e] border border-[#d4af37]/50 text-[#d4af37] py-4 rounded font-bold hover:bg-[#d4af37] hover:text-[#1a1a2e] transition">IV</button>
                    <button onclick="forcePhase(5)" class="bg-[#1a1a2e] border border-[#d4af37]/50 text-[#d4af37] py-4 rounded font-bold hover:bg-[#d4af37] hover:text-[#1a1a2e] transition">V</button>
                </div>
            </div>

            <!-- QR Codes Section -->
            <div class="mt-8 bg-black/40 rounded-lg p-6 border border-[#d4af37]/30">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-title font-bold text-[#d4af37]">QR-–∫–æ–¥—ã –¥–ª—è –ø–µ—á–∞—Ç–∏</h3>
                    <button onclick="printQRCodes()" class="btn-secondary-detective text-sm">üñ®Ô∏è –ü–ï–ß–ê–¢–¨</button>
                </div>
                <div id="qr-codes-container" class="qr-display">
                    <!-- QR codes will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- TEAM PANEL -->
    <div id="team-panel" class="hidden min-h-screen flex flex-col relative z-10">
        
        <!-- CONNECT -->
        <div id="team-connect" class="flex-1 flex flex-col items-center justify-center p-4">
            <div class="w-full max-w-lg">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full border-4 border-[#d4af37] flex items-center justify-center bg-[#1a1a2e]">
                        <span class="text-5xl">üé≠</span>
                    </div>
                    <h2 class="text-4xl font-title font-bold text-[#d4af37] mb-2">–î–û–ü–£–°–ö –ö –î–ï–õ–£</h2>
                    <p class="text-gray-400 italic">–ü—Ä–µ–¥—ä—è–≤–∏—Ç–µ –≤–∞—à–∏ –ø–æ–ª–Ω–æ–º–æ—á–∏—è</p>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-black/40 rounded-lg p-6 border border-[#d4af37]/30">
                        <label class="text-sm text-[#d4af37] mb-3 block font-mono uppercase tracking-widest">–ù–æ–º–µ—Ä –¥–µ–ª–∞</label>
                        <input type="text" id="join-code" maxlength="4" placeholder="0000"
                               class="w-full bg-black/50 border-2 border-[#d4af37]/50 rounded-xl p-4 text-center text-4xl font-mono tracking-[0.5em] text-[#d4af37] focus:border-[#d4af37] focus:outline-none">
                    </div>
                    
                    <div class="bg-black/40 rounded-lg p-6 border border-[#d4af37]/30">
                        <label class="text-sm text-[#d4af37] mb-4 block font-mono uppercase tracking-widest">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</label>
                        <div class="grid grid-cols-5 gap-3">
                            <button onclick="selectTeam(1)" class="team-btn p-4 rounded border-2 border-[#d4af37]/30 hover:border-[#ff6b6b] hover:bg-[#ff6b6b]/10 text-[#ff6b6b] transition" data-t="1">
                                <div class="text-2xl mb-1">ü¶Ö</div>
                                <div class="text-xs font-bold">ALFA</div>
                            </button>
                            <button onclick="selectTeam(2)" class="team-btn p-4 rounded border-2 border-[#d4af37]/30 hover:border-[#4ecdc4] hover:bg-[#4ecdc4]/10 text-[#4ecdc4] transition" data-t="2">
                                <div class="text-2xl mb-1">üêâ</div>
                                <div class="text-xs font-bold">BRAVO</div>
                            </button>
                            <button onclick="selectTeam(3)" class="team-btn p-4 rounded border-2 border-[#d4af37]/30 hover:border-[#ffe66d] hover:bg-[#ffe66d]/10 text-[#ffe66d] transition" data-t="3">
                                <div class="text-2xl mb-1">ü¶Å</div>
                                <div class="text-xs font-bold">CHARLIE</div>
                            </button>
                            <button onclick="selectTeam(4)" class="team-btn p-4 rounded border-2 border-[#d4af37]/30 hover:border-[#a8e6cf] hover:bg-[#a8e6cf]/10 text-[#a8e6cf] transition" data-t="4">
                                <div class="text-2xl mb-1">ü¶ä</div>
                                <div class="text-xs font-bold">DELTA</div>
                            </button>
                            <button onclick="selectTeam(5)" class="team-btn p-4 rounded border-2 border-[#d4af37]/30 hover:border-[#ff8b94] hover:bg-[#ff8b94]/10 text-[#ff8b94] transition" data-t="5">
                                <div class="text-2xl mb-1">üê∫</div>
                                <div class="text-xs font-bold">ECHO</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-black/40 rounded-lg p-6 border border-[#d4af37]/30">
                        <label class="text-sm text-[#d4af37] mb-4 block font-mono uppercase tracking-widest">–°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã (4 –∞–≥–µ–Ω—Ç–∞)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="p1" placeholder="–ê–≥–µ–Ω—Ç 1 (–ê–Ω–∞–ª–∏—Ç–∏–∫)" class="w-full bg-black/50 border border-[#d4af37]/30 rounded-lg p-3 text-[#d4af37] focus:border-[#d4af37] focus:outline-none">
                            <input type="text" id="p2" placeholder="–ê–≥–µ–Ω—Ç 2 (–¢–µ—Ö–Ω–∏–∫)" class="w-full bg-black/50 border border-[#d4af37]/30 rounded-lg p-3 text-[#d4af37] focus:border-[#d4af37] focus:outline-none">
                            <input type="text" id="p3" placeholder="–ê–≥–µ–Ω—Ç 3 (–ü–æ–ª–µ–≤–æ–π)" class="w-full bg-black/50 border border-[#d4af37]/30 rounded-lg p-3 text-[#d4af37] focus:border-[#d4af37] focus:outline-none">
                            <input type="text" id="p4" placeholder="–ê–≥–µ–Ω—Ç 4 (–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ)" class="w-full bg-black/50 border border-[#d4af37]/30 rounded-lg p-3 text-[#d4af37] focus:border-[#d4af37] focus:outline-none">
                        </div>
                    </div>
                    
                    <button onclick="joinGame()" class="w-full btn-detective text-lg">
                        üîê –ü–û–õ–£–ß–ò–¢–¨ –î–û–ü–£–°–ö
                    </button>
                    
                    <div id="join-err" class="hidden text-center text-[#ff6b6b] text-sm bg-[#ff6b6b]/10 p-4 rounded border border-[#ff6b6b]/30"></div>
                </div>
            </div>
        </div>
        
        <!-- WAIT -->
        <div id="team-wait" class="hidden flex-1 flex flex-col items-center justify-center p-4">
            <div class="text-center max-w-md">
                <div class="relative mb-8">
                    <div class="w-32 h-32 mx-auto rounded-full border-4 border-[#d4af37] p-2 animate-pulse">
                        <div class="w-full h-full rounded-full bg-[#d4af37]/20 flex items-center justify-center">
                            <span class="text-6xl">‚è≥</span>
                        </div>
                    </div>
                </div>
                
                <h2 class="text-3xl font-title font-bold text-[#d4af37] mb-4">–û–ñ–ò–î–ê–ù–ò–ï –î–û–ü–£–°–ö–ê</h2>
                
                <div class="bg-black/60 rounded-lg p-6 border border-[#d4af37]/30 mb-6">
                    <div class="team-badge mb-4 mx-auto">
                        <span id="wait-team-emoji">ü¶Ö</span>
                        <span id="wait-team-name" class="font-bold"></span>
                    </div>
                    <div class="text-sm text-gray-400 mb-3 uppercase tracking-widest">–ì—Ä—É–ø–ø–∞ –≥–æ—Ç–æ–≤–∞</div>
                    <div id="wait-players" class="space-y-2 text-left text-sm"></div>
                </div>
                
                <div class="flex items-center justify-center gap-2 text-[#d4af37] text-sm font-mono">
                    <span class="w-2 h-2 bg-[#4ade80] rounded-full animate-pulse"></span>
                    –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–∫–∞–∑–∞ –∏–∑ –¶–µ–Ω—Ç—Ä–∞...
                </div>
            </div>
        </div>
        
        <!-- GAME -->
        <div id="team-game" class="hidden flex-1 flex flex-col">
            <div class="bg-black/80 backdrop-blur border-b-2 border-[#d4af37]/50 p-4 sticky-header">
                <div class="max-w-4xl mx-auto flex justify-between items-center">
                    <div>
                        <div class="text-xs text-[#d4af37] font-mono uppercase mb-1">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞</div>
                        <div id="game-team-name" class="text-xl font-title font-bold text-[#d4af37]">---</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-[#d4af37] font-mono uppercase mb-1">–≠—Ç–∞–ø</div>
                        <div id="game-phase-num" class="text-3xl font-bold font-title">I</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-[#d4af37] font-mono uppercase mb-1">–í—Ä–µ–º—è</div>
                        <div id="game-timer" class="text-xl font-mono text-[#ff6b6b] bg-black/50 px-4 py-2 rounded border border-[#d4af37]/30">20:00</div>
                    </div>
                </div>
                <div class="investigation-progress max-w-4xl mx-auto mt-4">
                    <div class="investigation-progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="text-center py-6">
                <div id="phase-icon" class="text-5xl mb-4 inline-block">üèõÔ∏è</div>
                <h3 id="phase-title" class="text-2xl font-title font-bold text-[#d4af37] uppercase tracking-widest mb-2">–ó–ê–õ –ò–°–ö–£–°–°–¢–í</h3>
                <p id="phase-subtitle" class="text-gray-400 italic max-w-xl mx-auto px-4">–ü–æ–∏—Å–∫ –ø–µ—Ä–≤—ã—Ö —É–ª–∏–∫...</p>
            </div>
            
            <!-- Phase Navigation -->
            <div class="phase-nav">
                <button class="phase-btn" id="phase1-btn" onclick="switchPhase(1)">1</button>
                <button class="phase-btn" id="phase2-btn" onclick="switchPhase(2)">2</button>
                <button class="phase-btn" id="phase3-btn" onclick="switchPhase(3)">3</button>
                <button class="phase-btn" id="phase4-btn" onclick="switchPhase(4)">4</button>
                <button class="phase-btn locked" id="phase5-btn" onclick="switchPhase(5)" title="–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ —ç—Ç–∞–ø—ã 1-4">5</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 pb-32 max-w-4xl mx-auto w-full" id="cards-container"></div>
        </div>
    </div>

    <!-- QR SCANNER MODAL -->
    <div id="qr-modal" class="hidden fixed inset-0 modal-overlay z-[200] flex flex-col">
        <div class="p-6 flex justify-between items-center border-b border-[#d4af37]/30">
            <h3 class="text-lg font-title font-bold text-[#d4af37]">üì∑ –°–∫–∞–Ω–µ—Ä —É–ª–∏–∫</h3>
            <button onclick="closeQR()" class="text-[#d4af37] text-2xl hover:text-white transition">‚úï</button>
        </div>
        <div class="flex-1 flex items-center justify-center p-4">
            <div id="qr-reader" class="w-full max-w-sm"></div>
        </div>
        <div id="qr-scanner-status" class="p-4 text-center text-gray-400 text-sm italic">
            –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —É–ª–∏–∫–∏
        </div>
        <div class="p-4 flex justify-center gap-4">
            <button onclick="closeQR()" class="btn-secondary-detective text-sm">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <!-- VICTORY -->
    <div id="victory-modal" class="hidden fixed inset-0 modal-overlay z-[300] flex items-center justify-center p-4">
        <div class="text-center max-w-2xl w-full">
            <div class="text-8xl mb-6">üèÜ</div>
            <h2 class="text-5xl font-title font-bold text-[#d4af37] mb-4">–î–ï–õ–û –†–ê–°–ö–†–´–¢–û!</h2>
            <p class="text-xl text-gray-300 mb-6">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –º—É–∑–µ–π</p>
            
            <div class="case-file rounded-lg p-8 mb-8 text-left">
                <div class="text-center mb-6">
                    <p class="text-lg text-[#1a1a2e]/70 mb-2">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞</p>
                    <div id="vic-team" class="text-3xl font-title font-bold text-[#1a1a2e] mb-4"></div>
                </div>
                
                <div class="bg-[#1a1a2e]/5 p-6 rounded border-2 border-[#d4af37] text-center">
                    <p class="text-sm text-[#1a1a2e]/60 uppercase tracking-widest mb-2">–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ</p>
                    <div id="vic-word" class="text-4xl font-mono font-bold text-[#8b0000] tracking-[0.3em]"></div>
                </div>
            </div>
            
            <button onclick="location.reload()" class="btn-detective text-lg px-12">
                –ù–û–í–û–ï –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ==================== FIREBASE ====================
        let firebaseConfig = null;
        let db = null;
        let gameRef = null;
        let globalTimerInterval = null;
        let localTimerInterval = null;
        let lastTimerUpdate = Date.now();
        let localTimeLeft = 1200; // 20 –º–∏–Ω—É—Ç –ª–æ–∫–∞–ª—å–Ω–æ - –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Ç–∞–π–º–µ—Ä
        let gameStartTime = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
        
        const saved = localStorage.getItem('fb_config');
        if (saved) {
            try {
                firebaseConfig = JSON.parse(saved);
                document.getElementById('fb-config').value = saved;
            } catch(e) {}
        }
        
        function saveConfig() {
            try {
                const cfg = JSON.parse(document.getElementById('fb-config').value.trim());
                if (cfg.apiKey && cfg.databaseURL) {
                    localStorage.setItem('fb_config', JSON.stringify(cfg));
                    firebaseConfig = cfg;
                    document.getElementById('config-ok').classList.remove('hidden');
                    setTimeout(() => document.getElementById('config-ok').classList.add('hidden'), 3000);
                }
            } catch(e) {
                alert('–û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!');
            }
        }
        
        function initFB() {
            if (!firebaseConfig) {
                alert('–í–≤–µ–¥–∏—Ç–µ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é!');
                return false;
            }
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.database();
                db.goOffline();
                db.goOnline();
                updateConn('‚ö° –û–ù–õ–ê–ô–ù', 'conn-online');
                return true;
            } catch(e) {
                updateConn('‚ö† –û–®–ò–ë–ö–ê', 'conn-offline');
                return false;
            }
        }
        
        function updateConn(text, cls) {
            const el = document.getElementById('conn-status');
            el.textContent = text;
            el.className = 'conn-status ' + cls;
        }

        // ==================== DATA - MUSEUM THEFT ====================
        
        const TEAMS = [
            {
                id: 1,
                name: 'ALFA',
                emoji: 'ü¶Ö',
                color: '#ff6b6b',
                anagram: '–î–†–£–ñ–ë–ê',
                letters: '–î–†–£–ñ–ë–ê',
                hint: '–¢–æ, —á—Ç–æ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤–æ–µ–¥–∏–Ω–æ'
            },
            {
                id: 2,
                name: 'BRAVO',
                emoji: 'üêâ',
                color: '#4ecdc4',
                anagram: '–¢–û–í–ê–†–ò–©',
                letters: '–¢–û–í–ê–†–ò–©',
                hint: '–ë–ª–∏–∑–∫–∏–π –¥—Ä—É–≥ –∏ —Å–æ—Ä–∞—Ç–Ω–∏–∫'
            },
            {
                id: 3,
                name: 'CHARLIE',
                emoji: 'ü¶Å',
                color: '#ffe66d',
                anagram: '–ï–î–ò–ù–°–¢–í–û',
                letters: '–ï–î–ò–ù–°–¢–í–û',
                hint: '–°–æ—é–∑, —Å–ø–ª–æ—á–µ–Ω–Ω–æ—Å—Ç—å'
            },
            {
                id: 4,
                name: 'DELTA',
                emoji: 'ü¶ä',
                color: '#a8e6cf',
                anagram: '–°–û–î–†–£–ñ–ï–°–¢–í–û',
                letters: '–°–û–î–†–£–ñ–ï–°–¢–í–û',
                hint: '–î—Ä—É–∂–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –ª—é–¥—å–º–∏'
            },
            {
                id: 5,
                name: 'ECHO',
                emoji: 'üê∫',
                color: '#ff8b94',
                anagram: '–ë–†–ê–¢–°–¢–í–û',
                letters: '–ë–†–ê–¢–°–¢–í–û',
                hint: '–ö—Ä–µ–ø–∫–∞—è —Å–≤—è–∑—å –∫–∞–∫ —É –±—Ä–∞—Ç—å–µ–≤'
            }
        ];
        
        const CHAPTERS = [
            { id: 1, title: '–ó–ê–õ –ò–°–ö–£–°–°–¢–í', subtitle: '–ü–µ—Ä–≤—ã–µ —É–ª–∏–∫–∏ –Ω–∞ –º–µ—Å—Ç–µ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è', icon: 'üèõÔ∏è', theme: 'bg-museum' },
            { id: 2, title: '–°–õ–£–ñ–ë–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò', subtitle: '–ò–∑—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∫–∞–º–µ—Ä', icon: 'üìπ', theme: 'bg-museum' },
            { id: 3, title: '–ì–ê–õ–ï–†–ï–Ø –≠–ö–°–ü–û–ù–ê–¢–û–í', subtitle: '–ü–æ–∏—Å–∫ —Å–ø—Ä—è—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π', icon: 'üñºÔ∏è', theme: 'bg-museum' },
            { id: 4, title: '–ü–û–î–í–ê–õ–¨–ù–´–ï –ü–û–ú–ï–©–ï–ù–ò–Ø', subtitle: '–°–µ–∫—Ä–µ—Ç–Ω—ã–µ —Ö–æ–¥—ã –º—É–∑–µ—è', icon: 'üóùÔ∏è', theme: 'bg-museum' },
            { id: 5, title: '–°–ï–ô–§ –•–†–ê–ù–ò–¢–ï–õ–Ø', subtitle: '–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞', icon: 'üîê', theme: 'bg-museum' }
        ];
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        function generateEquations(teamId) {
            const baseEquations = [
                // –ö–æ–º–∞–Ω–¥–∞ 1 - ALFA
                [
                    { eq: '2x + 5 = 25', ans: 10 },
                    { eq: '3x - 7 = 14', ans: 7 },
                    { eq: '4x + 8 = 32', ans: 6 },
                    { eq: '5x - 3 = 27', ans: 6 }
                ],
                // –ö–æ–º–∞–Ω–¥–∞ 2 - BRAVO
                [
                    { eq: 'x + 15 = 42', ans: 27 },
                    { eq: '2x - 9 = 31', ans: 20 },
                    { eq: '3x + 12 = 48', ans: 12 },
                    { eq: '4x - 16 = 24', ans: 10 }
                ],
                // –ö–æ–º–∞–Ω–¥–∞ 3 - CHARLIE
                [
                    { eq: '6 + 2x = 24', ans: 9 },
                    { eq: '8x - 5 = 35', ans: 5 },
                    { eq: '3x + 7 = 28', ans: 7 },
                    { eq: '5x - 8 = 17', ans: 5 }
                ],
                // –ö–æ–º–∞–Ω–¥–∞ 4 - DELTA
                [
                    { eq: '7x + 3 = 31', ans: 4 },
                    { eq: '2x - 11 = 9', ans: 10 },
                    { eq: '9x + 6 = 42', ans: 4 },
                    { eq: '4x - 7 = 25', ans: 8 }
                ],
                // –ö–æ–º–∞–Ω–¥–∞ 5 - ECHO
                [
                    { eq: 'x - 8 = 19', ans: 27 },
                    { eq: '3x + 14 = 41', ans: 9 },
                    { eq: '6x - 13 = 29', ans: 7 },
                    { eq: '2x + 18 = 46', ans: 14 }
                ]
            ];
            return baseEquations[teamId - 1] || baseEquations[0];
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ç–∫–∏ 20x20 –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–ª–æ–≤ (–¥–∏–∞–≥–æ–Ω–∞–ª—å)
        function generateWordSearch20x20(teamId) {
            const wordGrids = {
                1: { // ALFA - —Å–ª–æ–≤–æ "–î–†–£–ñ–ë–ê" –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –≤–Ω–∏–∑-–≤–ø—Ä–∞–≤–æ
                    grid: generateRandomGrid(20, 20, '–î–†–£–ñ–ë–ê', 5, 5, 'down-right'),
                    word: '–î–†–£–ñ–ë–ê',
                    startRow: 5,
                    startCol: 5,
                    direction: 'down-right'
                },
                2: { // BRAVO - —Å–ª–æ–≤–æ "–¢–û–í–ê–†–ò–©" –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –≤–Ω–∏–∑-–≤–ª–µ–≤–æ
                    grid: generateRandomGrid(20, 20, '–¢–û–í–ê–†–ò–©', 3, 15, 'down-left'),
                    word: '–¢–û–í–ê–†–ò–©',
                    startRow: 3,
                    startCol: 15,
                    direction: 'down-left'
                },
                3: { // CHARLIE - —Å–ª–æ–≤–æ "–ï–î–ò–ù–°–¢–í–û" –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –≤–≤–µ—Ä—Ö-–≤–ø—Ä–∞–≤–æ
                    grid: generateRandomGrid(20, 20, '–ï–î–ò–ù–°–¢–í–û', 12, 3, 'up-right'),
                    word: '–ï–î–ò–ù–°–¢–í–û',
                    startRow: 12,
                    startCol: 3,
                    direction: 'up-right'
                },
                4: { // DELTA - —Å–ª–æ–≤–æ "–°–û–î–†–£–ñ–ï–°–¢–í–û" –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –≤–≤–µ—Ä—Ö-–≤–ª–µ–≤–æ
                    grid: generateRandomGrid(20, 20, '–°–û–î–†–£–ñ–ï–°–¢–í–û', 18, 16, 'up-left'),
                    word: '–°–û–î–†–£–ñ–ï–°–¢–í–û',
                    startRow: 18,
                    startCol: 16,
                    direction: 'up-left'
                },
                5: { // ECHO - —Å–ª–æ–≤–æ "–ë–†–ê–¢–°–¢–í–û" –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –≤–Ω–∏–∑-–≤–ø—Ä–∞–≤–æ
                    grid: generateRandomGrid(20, 20, '–ë–†–ê–¢–°–¢–í–û', 8, 8, 'down-right'),
                    word: '–ë–†–ê–¢–°–¢–í–û',
                    startRow: 8,
                    startCol: 8,
                    direction: 'down-right'
                }
            };
            return wordGrids[teamId] || wordGrids[1];
        }

        function generateRandomGrid(rows, cols, word, startRow, startCol, direction) {
            const letters = '–ê–ë–í–ì–î–ï–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø';
            const grid = [];
            
            // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å–µ—Ç–∫—É
            for (let i = 0; i < rows; i++) {
                grid[i] = [];
                for (let j = 0; j < cols; j++) {
                    grid[i][j] = letters[Math.floor(Math.random() * letters.length)];
                }
            }
            
            // –†–∞–∑–º–µ—â–∞–µ–º —Å–ª–æ–≤–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏
            const wordLetters = word.split('');
            let row = startRow;
            let col = startCol;
            
            for (let i = 0; i < wordLetters.length; i++) {
                if (row >= 0 && row < rows && col >= 0 && col < cols) {
                    grid[row][col] = wordLetters[i];
                }
                
                // –î–≤–∏–≥–∞–µ–º—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                switch(direction) {
                    case 'down-right':
                        row++;
                        col++;
                        break;
                    case 'down-left':
                        row++;
                        col--;
                        break;
                    case 'up-right':
                        row--;
                        col++;
                        break;
                    case 'up-left':
                        row--;
                        col--;
                        break;
                }
            }
            
            return grid;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ç–∫–∏ 7x7 –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
        function generateWordSearch(teamId) {
            const wordGrids = {
                1: { // ALFA - —Å–ª–æ–≤–æ "–î–†–£–ñ–ë–ê"
                    grid: [
                        ['–î', '–†', '–£', '–ñ', '–ë', '–ê', '–ú'],
                        ['–û', '–õ', '–ï', '–ö', '–°', '–¢', '–†'],
                        ['–ü', '–£', '–°', '–¢', '–û', '–ô', '–ó'],
                        ['–ù', '–í', '–ì', '–î', '–´', '–ú', '–ß'],
                        ['–°', '–Ø', '–¢', '–¨', '–§', '–¶', '–≠'],
                        ['–Æ', '–ô', '–ò', '–ö', '–õ', '–ú', '–ù'],
                        ['–•', '–™', '–©', '–®', '–ü', '–†', '–û']
                    ],
                    word: '–î–†–£–ñ–ë–ê',
                    positions: [[0,0], [0,1], [0,2], [0,3], [0,4], [0,5]]
                },
                2: { // BRAVO - —Å–ª–æ–≤–æ "–¢–û–í–ê–†–ò–©"
                    grid: [
                        ['–¢', '–û', '–í', '–ê', '–†', '–ò', '–©'],
                        ['–ö', '–õ', '–ú', '–ù', '–ü', '–°', '–¢'],
                        ['–£', '–§', '–•', '–¶', '–ß', '–®', '–´'],
                        ['–¨', '–≠', '–Æ', '–Ø', '–ô', '–™', '–Å'],
                        ['–ñ', '–ó', '–ò', '–ö', '–õ', '–ú', '–ù'],
                        ['–û', '–ü', '–†', '–°', '–¢', '–£', '–§'],
                        ['–•', '–¶', '–ß', '–®', '–©', '–´', '–¨']
                    ],
                    word: '–¢–û–í–ê–†–ò–©',
                    positions: [[0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6]]
                },
                3: { // CHARLIE - —Å–ª–æ–≤–æ "–ï–î–ò–ù–°–¢–í–û"
                    grid: [
                        ['–ï', '–î', '–ò', '–ù', '–°', '–¢', '–í'],
                        ['–û', '–ü', '–†', '–°', '–¢', '–£', '–§'],
                        ['–•', '–¶', '–ß', '–®', '–©', '–´', '–¨'],
                        ['–≠', '–Æ', '–Ø', '–ô', '–™', '–Å', '–ñ'],
                        ['–ó', '–ò', '–ö', '–õ', '–ú', '–ù', '–û'],
                        ['–ü', '–†', '–°', '–¢', '–£', '–§', '–•'],
                        ['–¶', '–ß', '–®', '–©', '–´', '–¨', '–≠']
                    ],
                    word: '–ï–î–ò–ù–°–¢–í–û',
                    positions: [[0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6]]
                },
                4: { // DELTA - —Å–ª–æ–≤–æ "–°–û–î–†–£–ñ–ï–°–¢–í–û"
                    grid: [
                        ['–°', '–û', '–î', '–†', '–£', '–ñ', '–ï'],
                        ['–°', '–¢', '–í', '–û', '–ü', '–†', '–°'],
                        ['–¢', '–£', '–§', '–•', '–¶', '–ß', '–®'],
                        ['–©', '–´', '–¨', '–≠', '–Æ', '–Ø', '–ô'],
                        ['–™', '–Å', '–ñ', '–ó', '–ò', '–ö', '–õ'],
                        ['–ú', '–ù', '–û', '–ü', '–†', '–°', '–¢'],
                        ['–£', '–§', '–•', '–¶', '–ß', '–®', '–©']
                    ],
                    word: '–°–û–î–†–£–ñ–ï–°–¢–í–û',
                    positions: [[0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6], [1,0], [1,1], [1,2], [1,3]]
                },
                5: { // ECHO - —Å–ª–æ–≤–æ "–ë–†–ê–¢–°–¢–í–û"
                    grid: [
                        ['–ë', '–†', '–ê', '–¢', '–°', '–¢', '–í'],
                        ['–û', '–ü', '–†', '–°', '–¢', '–£', '–§'],
                        ['–•', '–¶', '–ß', '–®', '–©', '–´', '–¨'],
                        ['–≠', '–Æ', '–Ø', '–ô', '–™', '–Å', '–ñ'],
                        ['–ó', '–ò', '–ö', '–õ', '–ú', '–ù', '–û'],
                        ['–ü', '–†', '–°', '–¢', '–£', '–§', '–•'],
                        ['–¶', '–ß', '–®', '–©', '–´', '–¨', '–≠']
                    ],
                    word: '–ë–†–ê–¢–°–¢–í–û',
                    positions: [[0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6], [1,5]]
                }
            };
            return wordGrids[teamId] || wordGrids[1];
        }
        
        const EVIDENCE = {
            // –≠–¢–ê–ü 1: –ó–ê–õ –ò–°–ö–£–°–°–¢–í
            chapter1: {
                ALFA: [
                    {
                        id: 'c1a1',
                        type: 'riddle',
                        title: '–ó–ê–ì–ê–î–ö–ê –°–¢–ê–†–û–ì–û –•–†–ê–ù–ò–¢–ï–õ–Ø',
                        description: '–ê–≥–µ–Ω—Ç 1: –†–µ—à–∏—Ç–µ –∑–∞–≥–∞–¥–∫—É, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É.',
                        riddle: '–Ø –±–µ–∑ —Ä—É–∫, –Ω–æ –º–æ–≥—É —É–¥–∞—Ä–∏—Ç—å. –Ø –±–µ–∑ –Ω–æ–≥, –Ω–æ –º–æ–≥—É –±–µ–∂–∞—Ç—å. –Ø –±–µ–∑ –≥–ª–∞–∑, –Ω–æ –º–æ–≥—É –ø–ª–∞–∫–∞—Ç—å. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–í–û–î–ê', '–í–û–î–ê', '–í–û–î–ê'].includes(val.toUpperCase()),
                        hint: '–≠—Ç–æ –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å —Å –Ω–µ–±–∞ –∏ —Ç–µ—á—å –≤ —Ä–µ–∫–∞—Ö',
                        player: 1
                    },
                    {
                        id: 'c1a2',
                        type: 'team_equations',
                        title: '–ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–î',
                        description: '–ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç —Å–≤–æ—ë —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –°–æ–µ–¥–∏–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–¥.',
                        teamId: 1,
                        checkAnswer: (val) => val === '10766',
                        hint: '–ó–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É –∞–≥–µ–Ω—Ç–æ–≤: 1-2-3-4'
                    },
                    {
                        id: 'c1a3',
                        type: 'scan',
                        title: '–°–ö–†–´–¢–ê–Ø –ó–ê–ü–ò–°–ö–ê',
                        description: '–ù–∞–π–¥–∏—Ç–µ QR-–∫–æ–¥ –ø–æ–¥ –≤–∞–∑–æ–π —É –≤—Ö–æ–¥–∞',
                        code: 'ALFA_NOTE_1',
                        hint: '–ù–∞–π–¥–∏—Ç–µ QR-–∫–æ–¥ –ø–æ–¥ –≤–∞–∑–æ–π —É –≤—Ö–æ–¥–∞',
                        checkAnswer: (val) => val === 'ALFA_NOTE_1'
                    },
                    {
                        id: 'c1a4',
                        type: 'wordsearch', // –°–µ—Ç–∫–∞ 7x7 –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
                        title: '–°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 7x7, —Å–æ–µ–¥–∏–Ω—è—è –±—É–∫–≤—ã –ø–æ –ø–æ—Ä—è–¥–∫—É',
                        hint: '–ò—â–∏—Ç–µ —Å–ª–æ–≤–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏',
                        teamId: 1,
                        checkAnswer: (val) => val === '–î–†–£–ñ–ë–ê'
                    },
                    {
                        id: 'c1a5',
                        type: 'cipher',
                        title: '–®–ò–§–† –¶–ï–ó–ê–†–Ø',
                        description: '–†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –ö–î–û–†–ü (—Å–¥–≤–∏–≥ +1)',
                        checkAnswer: (val) => val.toUpperCase() === '–õ–ï–ü–°–¢',
                        hint: '–ö–∞–∂–¥–∞—è –±—É–∫–≤–∞ —Å–¥–≤–∏–Ω—É—Ç–∞ –Ω–∞ 1 –≤–ø–µ—Ä—ë–¥ –≤ –∞–ª—Ñ–∞–≤–∏—Ç–µ'
                    }
                ],
                BRAVO: [
                    {
                        id: 'c1b1',
                        type: 'riddle',
                        title: '–ó–ê–ì–ê–î–ö–ê –î–û–†–ò–ô–°–ö–û–ô –ö–û–õ–û–ù–ù–´',
                        description: '–ê–≥–µ–Ω—Ç 2: –ß—Ç–æ —ç—Ç–æ –∑–∞ –ø—Ä–µ–¥–º–µ—Ç?',
                        riddle: '–£ –º–µ–Ω—è –µ—Å—Ç—å –≥–æ—Ä–ª–æ, –Ω–æ —è –Ω–µ –º–æ–≥—É –≥–ª–æ—Ç–∞—Ç—å. –£ –º–µ–Ω—è –µ—Å—Ç—å —Å–ø–∏–Ω–∞, –Ω–æ —è –Ω–µ –º–æ–≥—É –ª–µ–∂–∞—Ç—å. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ë–£–¢–´–õ–ö–ê', '–ë–£–¢–´–õ–ö–ê', '–§–õ–Ø–ì–ê'].includes(val.toUpperCase()),
                        hint: '–í —ç—Ç–æ–º —Ö—Ä–∞–Ω—è—Ç –∂–∏–¥–∫–æ—Å—Ç—å',
                        player: 2
                    },
                    {
                        id: 'c1b2',
                        type: 'team_equations',
                        title: '–ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–î',
                        description: '–ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç —Å–≤–æ—ë —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –°–æ–µ–¥–∏–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–¥.',
                        teamId: 2,
                        checkAnswer: (val) => val === '27201210',
                        hint: '–ó–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É –∞–≥–µ–Ω—Ç–æ–≤: 1-2-3-4'
                    },
                    {
                        id: 'c1b3',
                        type: 'scan',
                        title: '–¢–ê–ô–ù–ò–ö –£ –ö–û–õ–û–ù–ù–´',
                        description: 'QR-–∫–æ–¥ –Ω–∞ –¥—Ä–µ–≤–Ω–µ–π –∫–æ–ª–æ–Ω–Ω–µ',
                        code: 'BRAVO_COL_1',
                        hint: 'QR-–∫–æ–¥ –Ω–∞ –¥—Ä–µ–≤–Ω–µ–π –∫–æ–ª–æ–Ω–Ω–µ',
                        checkAnswer: (val) => val === 'BRAVO_COL_1'
                    },
                    {
                        id: 'c1b4',
                        type: 'wordsearch',
                        title: '–°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 7x7, —Å–æ–µ–¥–∏–Ω—è—è –±—É–∫–≤—ã –ø–æ –ø–æ—Ä—è–¥–∫—É',
                        hint: '–ò—â–∏—Ç–µ —Å–ª–æ–≤–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏',
                        teamId: 2,
                        checkAnswer: (val) => val === '–¢–û–í–ê–†–ò–©'
                    },
                    {
                        id: 'c1b5',
                        type: 'cipher',
                        title: '–ê–¢–ë–ê–®',
                        description: '–†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –ì–°–õ–ò–í (–ê—Ç–±–∞—à)',
                        checkAnswer: (val) => val.toUpperCase() === '–¢–û–†–ü–ï',
                        hint: '–ê ‚Üî –Ø, –ë ‚Üî –Æ, –í ‚Üî –≠...'
                    }
                ],
                CHARLIE: [
                    {
                        id: 'c1c1',
                        type: 'riddle',
                        title: '–ó–ê–ì–ê–î–ö–ê –°–§–ò–ù–ö–°–ê',
                        description: '–ê–≥–µ–Ω—Ç—ã 1 –∏ 2: –ß—Ç–æ —ç—Ç–æ –∑–∞ —Å—É—â–µ—Å—Ç–≤–æ?',
                        riddle: '–£—Ç—Ä–æ–º –Ω–∞ —á–µ—Ç—ã—Ä—ë—Ö, –¥–Ω—ë–º –Ω–∞ –¥–≤—É—Ö, –≤–µ—á–µ—Ä–æ–º –Ω–∞ —Ç—Ä—ë—Ö. –ß—Ç–æ —ç—Ç–æ?',
                        checkAnswer: (val) => ['–ß–ï–õ–û–í–ï–ö', '–ß–ï–õ–û–í–ï–ö'].includes(val.toUpperCase()),
                        hint: '–î—É–º–∞—é –æ –∂–∏–∑–Ω–µ–Ω–Ω–æ–º –ø—É—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞',
                        players: [1, 2]
                    },
                    {
                        id: 'c1c2',
                        type: 'team_equations',
                        title: '–ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–î',
                        description: '–ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç —Å–≤–æ—ë —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –°–æ–µ–¥–∏–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–¥.',
                        teamId: 3,
                        checkAnswer: (val) => val === '9575',
                        hint: '–ó–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É –∞–≥–µ–Ω—Ç–æ–≤: 1-2-3-4'
                    },
                    {
                        id: 'c1c3',
                        type: 'scan',
                        title: '–°–ö–†–´–¢–ê–Ø –ö–ê–ú–ï–†–ê',
                        description: '–ù–∞ —Å—Ç–∞—Ç—É–µ —Å—Ñ–∏–Ω–∫—Å–∞',
                        code: 'CHARLIE_CAM_1',
                        hint: '–ù–∞ —Å—Ç–∞—Ç—É–µ —Å—Ñ–∏–Ω–∫—Å–∞',
                        checkAnswer: (val) => val === 'CHARLIE_CAM_1'
                    },
                    {
                        id: 'c1c4',
                        type: 'wordsearch',
                        title: '–°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 7x7, —Å–æ–µ–¥–∏–Ω—è—è –±—É–∫–≤—ã –ø–æ –ø–æ—Ä—è–¥–∫—É',
                        hint: '–ò—â–∏—Ç–µ —Å–ª–æ–≤–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏',
                        teamId: 3,
                        checkAnswer: (val) => val === '–ï–î–ò–ù–°–¢–í–û'
                    },
                    {
                        id: 'c1c5',
                        type: 'cipher',
                        title: '–ü–û–†–Ø–î–û–ö –ë–£–ö–í',
                        description: '–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –±—É–∫–≤—ã: –†,–ê,–ì,–ê,–ù,–§ ‚Üí ?',
                        checkAnswer: (val) => val.toUpperCase() === '–§–ê–†–ê–ì–ê–ù',
                        hint: '–ù–∞—á–Ω–∏—Ç–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –±—É–∫–≤—ã'
                    }
                ],
                DELTA: [
                    {
                        id: 'c1d1',
                        type: 'riddle',
                        title: '–ó–ê–ì–ê–î–ö–ê –ú–ò–ù–û–¢–ê–í–†–ê',
                        description: '–ê–≥–µ–Ω—Ç 4: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –≤—Å–µ–≥–¥–∞ –∏–¥—É, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏—Ö–æ–∂—É. –£ –º–µ–Ω—è –µ—Å—Ç—å —Ä–æ—Ç, –Ω–æ –Ω–µ –≥–æ–≤–æ—Ä—é. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–†–ï–ö–ê', '–†–ï–ö–ê'].includes(val.toUpperCase()),
                        hint: '–¢–µ—á—ë—Ç –∫ –º–æ—Ä—é',
                        player: 4
                    },
                    {
                        id: 'c1d2',
                        type: 'team_equations',
                        title: '–ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–î',
                        description: '–ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç —Å–≤–æ—ë —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –°–æ–µ–¥–∏–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–¥.',
                        teamId: 4,
                        checkAnswer: (val) => val === '41048',
                        hint: '–ó–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É –∞–≥–µ–Ω—Ç–æ–≤: 1-2-3-4'
                    },
                    {
                        id: 'c1d3',
                        type: 'scan',
                        title: '–ú–ï–¢–ö–ê –í –õ–ê–ë–ò–†–ò–ù–¢–ï',
                        description: '–ù–∞ —Å—Ç–µ–Ω–µ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞',
                        code: 'DELTA_MARK_1',
                        hint: '–ù–∞ —Å—Ç–µ–Ω–µ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞',
                        checkAnswer: (val) => val === 'DELTA_MARK_1'
                    },
                    {
                        id: 'c1d4',
                        type: 'wordsearch',
                        title: '–°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 7x7, —Å–æ–µ–¥–∏–Ω—è—è –±—É–∫–≤—ã –ø–æ –ø–æ—Ä—è–¥–∫—É',
                        hint: '–ò—â–∏—Ç–µ —Å–ª–æ–≤–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏',
                        teamId: 4,
                        checkAnswer: (val) => val === '–°–û–î–†–£–ñ–ï–°–¢–í–û'
                    },
                    {
                        id: 'c1d5',
                        type: 'cipher',
                        title: '–ó–ï–†–ö–ê–õ–¨–ù–´–ô –®–ò–§–†',
                        description: '–ê ‚Üî –Ø, –ö ‚Üî –°, –ú ‚Üî –¢... –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –ö–Ø–ú',
                        checkAnswer: (val) => val.toUpperCase() === '–°–ê–ù',
                        hint: '–ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –∞–ª—Ñ–∞–≤–∏—Ç–∞'
                    }
                ],
                ECHO: [
                    {
                        id: 'c1e1',
                        type: 'riddle',
                        title: '–ó–ê–ì–ê–î–ö–ê –û–†–ê–ö–£–õ–ê',
                        description: '–í—Å–µ –∞–≥–µ–Ω—Ç—ã: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–ß–µ–º –±–æ–ª—å—à–µ –∏–∑ –Ω–µ—ë –±–µ—Ä—ë—à—å, —Ç–µ–º –±–æ–ª—å—à–µ –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è. –ß—Ç–æ —ç—Ç–æ?',
                        checkAnswer: (val) => ['–Ø–ú–ê', '–Ø–ú–ê', '–ù–û–†–ê'].includes(val.toUpperCase()),
                        hint: '–ö–æ–ø–∞—é—Ç –≤ –∑–µ–º–ª–µ'
                    },
                    {
                        id: 'c1e2',
                        type: 'team_equations',
                        title: '–ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ö–û–î',
                        description: '–ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç —Å–≤–æ—ë —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –°–æ–µ–¥–∏–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–¥.',
                        teamId: 5,
                        checkAnswer: (val) => val === '279714',
                        hint: '–ó–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É –∞–≥–µ–Ω—Ç–æ–≤: 1-2-3-4'
                    },
                    {
                        id: 'c1e3',
                        type: 'scan',
                        title: '–°–í–ò–¢–û–ö –û–†–ê–ö–£–õ–ê',
                        description: '–í —É—Ä–Ω–µ —É —Å—Ç–∞—Ç—É–∏',
                        code: 'ECHO_SCROLL_1',
                        hint: '–í —É—Ä–Ω–µ —É —Å—Ç–∞—Ç—É–∏',
                        checkAnswer: (val) => val === 'ECHO_SCROLL_1'
                    },
                    {
                        id: 'c1e4',
                        type: 'wordsearch',
                        title: '–°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 7x7, —Å–æ–µ–¥–∏–Ω—è—è –±—É–∫–≤—ã –ø–æ –ø–æ—Ä—è–¥–∫—É',
                        hint: '–ò—â–∏—Ç–µ —Å–ª–æ–≤–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏',
                        teamId: 5,
                        checkAnswer: (val) => val === '–ë–†–ê–¢–°–¢–í–û'
                    },
                    {
                        id: 'c1e5',
                        type: 'cipher',
                        title: '–ß–ò–°–õ–û–í–û–ô –ö–û–î',
                        description: '–ê=1, –ë=2... –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: 4-1-18',
                        checkAnswer: (val) => val.toUpperCase() === '–î–ê–†',
                        hint: '4=–î, 1=–ê, 18=–†'
                    }
                ]
            },
            
            // –≠–¢–ê–ü 2: –°–õ–£–ñ–ë–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
            chapter2: {
                ALFA: [
                    {
                        id: 'c2a1',
                        type: 'riddle',
                        title: '–ö–ê–ú–ï–†–ê –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø',
                        description: '–ê–≥–µ–Ω—Ç 2: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –≤–∏–∂—É –≤—Å—ë, –Ω–æ —É –º–µ–Ω—è –Ω–µ—Ç –≥–ª–∞–∑. –Ø –∑–∞–ø–∏—Å—ã–≤–∞—é –≤—Å—ë, –Ω–æ –Ω–µ –º–æ–≥—É –≥–æ–≤–æ—Ä–∏—Ç—å. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ö–ê–ú–ï–†–ê', '–í–ò–î–ï–û–ö–ê–ú–ï–†–ê'].includes(val.toUpperCase()),
                        hint: '–°–Ω–∏–º–∞–µ—Ç –≤–∏–¥–µ–æ',
                        player: 2
                    },
                    {
                        id: 'c2a2',
                        type: 'team_binary',
                        title: '–ë–ò–ù–ê–†–ù–´–ô –ö–û–î –î–û–°–¢–£–ü–ê',
                        description: '–°–æ–µ–¥–∏–Ω–∏—Ç–µ –≤—Å–µ –≥—Ä—É–ø–ø—ã',
                        binary: ['1010', '0101', '1100', '0011'],
                        checkAnswer: (val) => val === '1010010111000011',
                        hint: '–°–æ–µ–¥–∏–Ω–∏—Ç–µ –≤—Å–µ –≥—Ä—É–ø–ø—ã'
                    },
                    {
                        id: 'c2a3',
                        type: 'scan',
                        title: '–î–ò–°–ö –î–û–°–¢–£–ü–ê',
                        description: '–ù–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ –æ—Ö—Ä–∞–Ω—ã',
                        code: 'ALFA_SEC_2',
                        hint: '–ù–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ –æ—Ö—Ä–∞–Ω—ã',
                        checkAnswer: (val) => val === 'ALFA_SEC_2'
                    },
                    {
                        id: 'c2a4',
                        type: 'wordsearch20x20', // –°–µ—Ç–∫–∞ 20x20 –¥–ª—è 4-–≥–æ –∑–∞–¥–∞–Ω–∏—è
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 1,
                        checkAnswer: (val) => val === '–î–†–£–ñ–ë–ê'
                    },
                    {
                        id: 'c2a5',
                        type: 'cipher',
                        title: '–®–ò–§–† –í–ò–ñ–ï–ù–ï–†–ê',
                        description: '–ö–ª—é—á: –ú–£–ó–ï–ô. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –´–ì–û–©',
                        checkAnswer: (val) => val.toUpperCase() === '–ö–û–î–´',
                        hint: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –í–∏–∂–µ–Ω–µ—Ä–∞'
                    }
                ],
                BRAVO: [
                    {
                        id: 'c2b1',
                        type: 'riddle',
                        title: '–°–ï–ô–§',
                        description: '–ê–≥–µ–Ω—Ç 1: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–£ –º–µ–Ω—è –µ—Å—Ç—å –∑—É–±—ã, –Ω–æ —è –Ω–µ –∫—É—Å–∞—é. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ö–õ–Æ–ß', '–ö–õ–Æ–ß'].includes(val.toUpperCase()),
                        hint: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–º–∫–∏',
                        player: 1
                    },
                    {
                        id: 'c2b2',
                        type: 'team_code',
                        title: '–ü–ò–ù-–ö–û–î',
                        description: '–ó–∞–ø–æ–º–Ω–∏—Ç–µ —Å–≤–æ—é —Ü–∏—Ñ—Ä—É',
                        digits: ['9', '3', '6', '1'],
                        checkAnswer: (val) => val === '9361',
                        hint: '–ó–∞–ø–æ–º–Ω–∏—Ç–µ —Å–≤–æ—é —Ü–∏—Ñ—Ä—É'
                    },
                    {
                        id: 'c2b3',
                        type: 'scan',
                        title: '–î–í–ï–†–¨ –°–ï–ô–§–ê',
                        description: '–ù–∞ –¥–≤–µ—Ä–∏ —Å–µ–π—Ñ–∞',
                        code: 'BRAVO_SAFE_2',
                        hint: '–ù–∞ –¥–≤–µ—Ä–∏ —Å–µ–π—Ñ–∞',
                        checkAnswer: (val) => val === 'BRAVO_SAFE_2'
                    },
                    {
                        id: 'c2b4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 2,
                        checkAnswer: (val) => val === '–¢–û–í–ê–†–ò–©'
                    },
                    {
                        id: 'c2b5',
                        type: 'cipher',
                        title: '–û–ë–†–ê–¢–ù–´–ô –ê–õ–§–ê–í–ò–¢',
                        description: '–Ø ‚Üî –ê, –Æ ‚Üî –ë... –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –Ø–Æ–°',
                        checkAnswer: (val) => val.toUpperCase() === '–ê–ë–ì',
                        hint: '–ê–ª—Ñ–∞–≤–∏—Ç –∑–∞–¥–æ–º –Ω–∞–ø–µ—Ä—ë–¥'
                    }
                ],
                CHARLIE: [
                    {
                        id: 'c2c1',
                        type: 'riddle',
                        title: '–°–ò–ì–ù–ê–õ–ò–ó–ê–¶–ò–Ø',
                        description: '–ê–≥–µ–Ω—Ç 3: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –∫—Ä–∏—á—É –±–µ–∑ –≥–æ–ª–æ—Å–∞, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é –±–µ–∑ —Å–ª–æ–≤. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–°–ò–†–ï–ù–ê', '–°–ò–†–ï–ù–ê', '–¢–†–ï–í–û–ì–ê'].includes(val.toUpperCase()),
                        hint: '–ì—Ä–æ–º–∫–∏–π –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª',
                        player: 3
                    },
                    {
                        id: 'c2c2',
                        type: 'team_morse',
                        title: '–°–ò–ì–ù–ê–õ –¢–†–ï–í–û–ì–ò',
                        description: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª –±–µ–¥—Å—Ç–≤–∏—è',
                        morse: ['...', '---', '...'],
                        checkAnswer: (val) => val.toUpperCase() === 'SOS',
                        hint: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª –±–µ–¥—Å—Ç–≤–∏—è'
                    },
                    {
                        id: 'c2c3',
                        type: 'scan',
                        title: '–ü–ê–ù–ï–õ–¨ –¢–†–ï–í–û–ì',
                        description: '–ù–∞ –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–≤–æ–≥',
                        code: 'CHARLIE_ALERT_2',
                        hint: '–ù–∞ –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–≤–æ–≥',
                        checkAnswer: (val) => val === 'CHARLIE_ALERT_2'
                    },
                    {
                        id: 'c2c4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 3,
                        checkAnswer: (val) => val === '–ï–î–ò–ù–°–¢–í–û'
                    },
                    {
                        id: 'c2c5',
                        type: 'cipher',
                        title: '–ü–û–õ–ò–ë–ò–ô–°–ö–ò–ô –ö–í–ê–î–†–ê–¢',
                        description: '–†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: 11 42 23',
                        checkAnswer: (val) => val.toUpperCase() === '–ê–ö–î',
                        hint: '–¢–∞–±–ª–∏—Ü–∞ 5x5 —Å –±—É–∫–≤–∞–º–∏'
                    }
                ],
                DELTA: [
                    {
                        id: 'c2d1',
                        type: 'riddle',
                        title: '–î–ê–¢–ß–ò–ö –î–í–ò–ñ–ï–ù–ò–Ø',
                        description: '–ê–≥–µ–Ω—Ç 4: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø —Å–ø–ª—é, –Ω–æ –≤–∏–∂—É. –Ø –º–æ–ª—á—É, –Ω–æ —Å–ª—ã—à—É. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–î–ê–¢–ß–ò–ö', '–°–ï–ù–°–û–†'].includes(val.toUpperCase()),
                        hint: '–†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ',
                        player: 4
                    },
                    {
                        id: 'c2d2',
                        type: 'team_shape',
                        title: '–ì–ï–û–ú–ï–¢–†–ò–ß–ï–°–ö–ò–ô –ö–õ–Æ–ß',
                        description: '–û–ø–∏—à–∏—Ç–µ —Ñ–∏–≥—É—Ä—ã –ø–æ –ø–æ—Ä—è–¥–∫—É',
                        shapes: ['–ö–†–£–ì', '–ö–í–ê–î–†–ê–¢', '–¢–†–ï–£–ì–û–õ–¨–ù–ò–ö', '–†–û–ú–ë'],
                        checkAnswer: (val) => val.toUpperCase() === '–ö–†–£–ì-–ö–í–ê–î–†–ê–¢-–¢–†–ï–£–ì–û–õ–¨–ù–ò–ö-–†–û–ú–ë',
                        hint: '–û–ø–∏—à–∏—Ç–µ —Ñ–∏–≥—É—Ä—ã –ø–æ –ø–æ—Ä—è–¥–∫—É'
                    },
                    {
                        id: 'c2d3',
                        type: 'scan',
                        title: '–î–ê–¢–ß–ò–ö –£ –î–í–ï–†–ò',
                        description: '–ù–∞ –¥–∞—Ç—á–∏–∫–µ —É –¥–≤–µ—Ä–∏',
                        code: 'DELTA_SENS_2',
                        hint: '–ù–∞ –¥–∞—Ç—á–∏–∫–µ —É –¥–≤–µ—Ä–∏',
                        checkAnswer: (val) => val === 'DELTA_SENS_2'
                    },
                    {
                        id: 'c2d4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 4,
                        checkAnswer: (val) => val === '–°–û–î–†–£–ñ–ï–°–¢–í–û'
                    },
                    {
                        id: 'c2d5',
                        type: 'cipher',
                        title: '–°–î–í–ò–ì –¶–ï–ó–ê–†–Ø',
                        description: '–°–¥–≤–∏–≥ +3. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –ï–õ–£–ë',
                        checkAnswer: (val) => val.toUpperCase() === '–ë–ò–†–ñ',
                        hint: '–°–¥–≤–∏–Ω—å—Ç–µ –∫–∞–∂–¥—É—é –±—É–∫–≤—É –Ω–∞ 3 –Ω–∞–∑–∞–¥'
                    }
                ],
                ECHO: [
                    {
                        id: 'c2e1',
                        type: 'riddle',
                        title: '–ñ–£–†–ù–ê–õ –ü–û–°–ï–©–ï–ù–ò–ô',
                        description: '–ê–≥–µ–Ω—Ç 1: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –ø–æ–º–Ω—é –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ, –Ω–æ –Ω–µ –º–æ–≥—É –≤—Å–ø–æ–º–Ω–∏—Ç—å —Å–∞–º. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ê–†–•–ò–í', '–ñ–£–†–ù–ê–õ', '–ë–ê–ó–ê'].includes(val.toUpperCase()),
                        hint: '–•—Ä–∞–Ω–∏–ª–∏—â–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
                        player: 1
                    },
                    {
                        id: 'c2e2',
                        type: 'team_rhythm',
                        title: '–°–¢–£–ö –í –¢–†–£–ë–ï',
                        description: '–ü–æ—Å—á–∏—Ç–∞–π—Ç–µ —É–¥–∞—Ä—ã',
                        rhythm: ['–¢–£–ö', '–¢–£–ö-–¢–£–ö', '–¢–£–ö-–¢–£–ö-–¢–£–ö', '–¢–£–ö'],
                        checkAnswer: (val) => val === '1-2-3-1',
                        hint: '–ü–æ—Å—á–∏—Ç–∞–π—Ç–µ —É–¥–∞—Ä—ã'
                    },
                    {
                        id: 'c2e3',
                        type: 'scan',
                        title: '–ñ–£–†–ù–ê–õ –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò',
                        description: '–í –∂—É—Ä–Ω–∞–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
                        code: 'ECHO_LOG_2',
                        hint: '–í –∂—É—Ä–Ω–∞–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
                        checkAnswer: (val) => val === 'ECHO_LOG_2'
                    },
                    {
                        id: 'c2e4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 5,
                        checkAnswer: (val) => val === '–ë–†–ê–¢–°–¢–í–û'
                    },
                    {
                        id: 'c2e5',
                        type: 'cipher',
                        title: '–ê–ù–ê–ì–†–ê–ú–ú–ê',
                        description: '–ü–µ—Ä–µ—Å—Ç–∞–≤—å—Ç–µ: –ö–ê–†–¢–ò–ù–ê',
                        checkAnswer: (val) => val.toUpperCase() === '–¢–ê–†–ê–ù–ö–ò',
                        hint: '–ù–∞—Å–µ–∫–æ–º—ã–µ –≤ –∫–∞—Ä—Ç–∏–Ω–µ?'
                    }
                ]
            },
            
            // –≠–¢–ê–ü 3: –ì–ê–õ–ï–†–ï–Ø –≠–ö–°–ü–û–ù–ê–¢–û–í
            chapter3: {
                ALFA: [
                    {
                        id: 'c3a1',
                        type: 'riddle',
                        title: '–ö–ê–†–¢–ò–ù–ê',
                        description: '–ê–≥–µ–Ω—Ç 3: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –ø–ª–∞—á—É –±–µ–∑ —Å–ª—ë–∑, —É–ª—ã–±–∞—é—Å—å –±–µ–∑ —É—Å—Ç. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ú–ê–°–ö–ê', '–õ–ò–¶–û', '–ö–ê–†–¢–ò–ù–ê'].includes(val.toUpperCase()),
                        hint: '–í–∏—Å–∏—Ç –≤ —Ä–∞–º–µ',
                        player: 3
                    },
                    {
                        id: 'c3a2',
                        type: 'team_art',
                        title: '–¶–í–ï–¢–ê –ö–ê–†–¢–ò–ù–´',
                        description: '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫—Ä–∞—Å–∫–∏',
                        colors: ['–ó–û–õ–û–¢–û', '–£–õ–¨–¢–†–ê–ú–ê–†–ò–ù', '–û–•–†–ê', '–ë–ï–õ–ò–õ–ê'],
                        checkAnswer: (val) => val.toUpperCase() === '–ó–û–õ–û–¢–û-–£–õ–¨–¢–†–ê–ú–ê–†–ò–ù-–û–•–†–ê-–ë–ï–õ–ò–õ–ê',
                        hint: '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫—Ä–∞—Å–∫–∏'
                    },
                    {
                        id: 'c3a3',
                        type: 'scan',
                        title: '–û–ë–û–†–û–¢ –ö–ê–†–¢–ò–ù–´',
                        description: '–ù–∞ –æ–±–æ—Ä–æ—Ç–µ –∫–∞—Ä—Ç–∏–Ω—ã',
                        code: 'ALFA_ART_3',
                        hint: '–ù–∞ –æ–±–æ—Ä–æ—Ç–µ –∫–∞—Ä—Ç–∏–Ω—ã',
                        checkAnswer: (val) => val === 'ALFA_ART_3'
                    },
                    {
                        id: 'c3a4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 1,
                        checkAnswer: (val) => val === '–î–†–£–ñ–ë–ê'
                    },
                    {
                        id: 'c3a5',
                        type: 'cipher',
                        title: '–ö–ù–ò–ñ–ù–´–ô –®–ò–§–†',
                        description: '–°—Ç—Ä–∞–Ω–∏—Ü–∞-–°—Ç—Ä–æ–∫–∞-–ë—É–∫–≤–∞: 12-3-5 8-1-2 15-2-1',
                        checkAnswer: (val) => val.toUpperCase() === '–ö–û–î',
                        hint: '–ù–∞–π–¥–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –±—É–∫–≤—ã –≤ –∫–Ω–∏–≥–µ'
                    }
                ],
                BRAVO: [
                    {
                        id: 'c3b1',
                        type: 'riddle',
                        title: '–°–ö–£–õ–¨–ü–¢–£–†–ê',
                        description: '–ê–≥–µ–Ω—Ç 2: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø —Å–æ–∑–¥–∞–Ω –∏–∑ –∫–∞–º–Ω—è, –Ω–æ –¥—ã—à—É –∂–∏–∑–Ω—å—é. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–°–¢–ê–¢–£–Ø', '–°–ö–£–õ–¨–ü–¢–£–†–ê'].includes(val.toUpperCase()),
                        hint: '–¢—Ä–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è',
                        player: 2
                    },
                    {
                        id: 'c3b2',
                        type: 'team_numbers',
                        title: '–î–ê–¢–ê –°–û–ó–î–ê–ù–ò–Ø',
                        description: '–ì–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è',
                        digits: ['1', '5', '0', '3'],
                        checkAnswer: (val) => val === '1503',
                        hint: '–ì–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è'
                    },
                    {
                        id: 'c3b3',
                        type: 'scan',
                        title: '–ü–û–°–¢–ê–ú–ï–ù–¢ –°–¢–ê–¢–£–ò',
                        description: '–ù–∞ –ø–æ—Å—Ç–∞–º–µ–Ω—Ç–µ —Å—Ç–∞—Ç—É–∏',
                        code: 'BRAVO_SCULPT_3',
                        hint: '–ù–∞ –ø–æ—Å—Ç–∞–º–µ–Ω—Ç–µ —Å—Ç–∞—Ç—É–∏',
                        checkAnswer: (val) => val === 'BRAVO_SCULPT_3'
                    },
                    {
                        id: 'c3b4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 2,
                        checkAnswer: (val) => val === '–¢–û–í–ê–†–ò–©'
                    },
                    {
                        id: 'c3b5',
                        type: 'cipher',
                        title: '–†–û–¢–û–†–ù–ê–Ø –ú–ê–®–ò–ù–ê',
                        description: '–†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –õ–ì–ü–ï–† (—Ä–æ—Ç–æ—Ä—ã: 3-1-2)',
                        checkAnswer: (val) => val.toUpperCase() === '–ï–ù–ò–ì–ú–ê',
                        hint: '–ù–µ–º–µ—Ü–∫–∞—è —à–∏—Ñ—Ä–æ–≤–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞'
                    }
                ],
                CHARLIE: [
                    {
                        id: 'c3c1',
                        type: 'riddle',
                        title: '–í–ê–ó–ê',
                        description: '–ê–≥–µ–Ω—Ç 4: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –∫—Ä–∞—Å–∏–≤–∞ —Å–Ω–∞—Ä—É–∂–∏, –ø—É—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–í–ê–ó–ê', '–°–û–°–£–î', '–ê–ú–§–û–†–ê'].includes(val.toUpperCase()),
                        hint: '–î—Ä–µ–≤–Ω–µ–≥—Ä–µ—á–µ—Å–∫–∏–π —Å–æ—Å—É–¥',
                        player: 4
                    },
                    {
                        id: 'c3c2',
                        type: 'team_directions',
                        title: '–ü–£–¢–¨ –ö –≠–ö–°–ü–û–ù–ê–¢–£',
                        description: '–°–ª–µ–¥—É–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∞–º',
                        directions: ['–ü–†–Ø–ú–û', '–ù–ê–õ–ï–í–û', '–ü–†–Ø–ú–û', '–ù–ê–ü–†–ê–í–û'],
                        checkAnswer: (val) => val.toUpperCase() === '–ü–†–Ø–ú–û-–ù–ê–õ–ï–í–û-–ü–†–Ø–ú–û-–ù–ê–ü–†–ê–í–û',
                        hint: '–°–ª–µ–¥—É–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∞–º'
                    },
                    {
                        id: 'c3c3',
                        type: 'scan',
                        title: '–î–ù–û –í–ê–ó–´',
                        description: '–î–Ω–æ –≤–∞–∑—ã',
                        code: 'CHARLIE_VASE_3',
                        hint: '–î–Ω–æ –≤–∞–∑—ã',
                        checkAnswer: (val) => val === 'CHARLIE_VASE_3'
                    },
                    {
                        id: 'c3c4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 3,
                        checkAnswer: (val) => val === '–ï–î–ò–ù–°–¢–í–û'
                    },
                    {
                        id: 'c3c5',
                        type: 'cipher',
                        title: '–õ–ò–ù–ï–ô–ö–ê –¶–ï–ó–ê–†–Ø',
                        description: '–°–¥–≤–∏–≥ +7. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –®–ß–ì–õ',
                        checkAnswer: (val) => val.toUpperCase() === '–ü–ê–¢–†–û–ù',
                        hint: '–°–¥–≤–∏–Ω—å—Ç–µ –Ω–∞ 7 –Ω–∞–∑–∞–¥'
                    }
                ],
                DELTA: [
                    {
                        id: 'c3d1',
                        type: 'riddle',
                        title: '–ú–û–ó–ê–ò–ö–ê',
                        description: '–ê–≥–µ–Ω—Ç 1: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø —Å–ª–æ–º–∞–Ω–∞ –Ω–∞ —Ç—ã—Å—è—á–∏ –∫—É—Å–∫–æ–≤, –Ω–æ —Ü–µ–ª–æ—Å—Ç–Ω–∞. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ú–û–ó–ê–ò–ö–ê', '–ü–ê–ù–ù–û'].includes(val.toUpperCase()),
                        hint: '–ö–∞—Ä—Ç–∏–Ω–∞ –∏–∑ –∫–∞–º–Ω–µ–π',
                        player: 1
                    },
                    {
                        id: 'c3d2',
                        type: 'team_symbols',
                        title: '–°–ò–ú–í–û–õ–´ –≠–ü–û–•–ò',
                        description: '–ù–µ–±–µ—Å–Ω—ã–µ —Ç–µ–ª–∞',
                        symbols: ['‚òÄÔ∏è', 'üåô', '‚≠ê', '‚ö°'],
                        checkAnswer: (val) => val.toUpperCase() === '–°–û–õ–ù–¶–ï-–õ–£–ù–ê-–ó–í–ï–ó–î–ê-–ú–û–õ–ù–ò–Ø',
                        hint: '–ù–µ–±–µ—Å–Ω—ã–µ —Ç–µ–ª–∞'
                    },
                    {
                        id: 'c3d3',
                        type: 'scan',
                        title: '–¶–ï–ù–¢–† –ú–û–ó–ê–ò–ö–ò',
                        description: '–í —Ü–µ–Ω—Ç—Ä–µ –º–æ–∑–∞–∏–∫–∏',
                        code: 'DELTA_MOSAIC_3',
                        hint: '–í —Ü–µ–Ω—Ç—Ä–µ –º–æ–∑–∞–∏–∫–∏',
                        checkAnswer: (val) => val === 'DELTA_MOSAIC_3'
                    },
                    {
                        id: 'c3d4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 4,
                        checkAnswer: (val) => val === '–°–û–î–†–£–ñ–ï–°–¢–í–û'
                    },
                    {
                        id: 'c3d5',
                        type: 'cipher',
                        title: '–¢–†–ê–ù–°–ü–û–ó–ò–¶–ò–Ø',
                        description: '–ü–µ—Ä–µ—Å—Ç–∞–≤—å—Ç–µ –±—É–∫–≤—ã: –ú–ê–†–ò–û–ù–ï–¢–ö–ê ‚Üí ?',
                        checkAnswer: (val) => val.toUpperCase() === '–ù–ï–¢–†–ê–ú–ï–¢–û–ö–ê',
                        hint: '–ù–æ–≤–æ–µ —Å–ª–æ–≤–æ –∏–∑ —Ç–µ—Ö –∂–µ –±—É–∫–≤'
                    }
                ],
                ECHO: [
                    {
                        id: 'c3e1',
                        type: 'riddle',
                        title: '–ì–û–ë–ï–õ–ï–ù',
                        description: '–ê–≥–µ–Ω—Ç 3: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—é –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ —Å–ª–æ–≤, —Ç–∫–∞–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ì–û–ë–ï–õ–ï–ù', '–ö–û–í–Å–†', '–¢–ö–ê–ù–¨'].includes(val.toUpperCase()),
                        hint: '–ù–∞—Å—Ç–µ–Ω–Ω–æ–µ –ø–æ–ª–æ—Ç–Ω–æ',
                        player: 3
                    },
                    {
                        id: 'c3e2',
                        type: 'team_memory',
                        title: '–°–Æ–ñ–ï–¢ –ì–û–ë–ï–õ–ï–ù–ê',
                        description: '–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤–∞—è —Å—Ü–µ–Ω–∞',
                        questions: [
                            { q: '–ö—Ç–æ –Ω–∞ –∫–æ–Ω–µ?', a: '–†–´–¶–ê–†–¨', player: 1 },
                            { q: '–ß—Ç–æ –≤ —Ä—É–∫–µ?', a: '–ö–û–ü–¨–ï', player: 2 },
                            { q: '–¶–≤–µ—Ç –∫–æ–Ω—è?', a: '–ë–ï–õ–´–ô', player: 3 },
                            { q: '–§–æ–Ω?', a: '–ó–ê–ú–û–ö', player: 4 }
                        ],
                        checkAnswer: (answers) => {
                            const correct = ['–†–´–¶–ê–†–¨', '–ö–û–ü–¨–ï', '–ë–ï–õ–´–ô', '–ó–ê–ú–û–ö'];
                            return answers.every((a, i) => a.toUpperCase() === correct[i]);
                        },
                        hint: '–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤–∞—è —Å—Ü–µ–Ω–∞'
                    },
                    {
                        id: 'c3e3',
                        type: 'scan',
                        title: '–ó–ê –ì–û–ë–ï–õ–ï–ù–û–ú',
                        description: '–ó–∞ –≥–æ–±–µ–ª–µ–Ω–æ–º',
                        code: 'ECHO_TAPESTRY_3',
                        hint: '–ó–∞ –≥–æ–±–µ–ª–µ–Ω–æ–º',
                        checkAnswer: (val) => val === 'ECHO_TAPESTRY_3'
                    },
                    {
                        id: 'c3e4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 5,
                        checkAnswer: (val) => val === '–ë–†–ê–¢–°–¢–í–û'
                    },
                    {
                        id: 'c3e5',
                        type: 'cipher',
                        title: '–ë–ï–ô–ö–û–ù–û–í–°–ö–ò–ô –®–ò–§–†',
                        description: 'A=AAAAA, B=AAAAB... –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: AABAA AABAB',
                        checkAnswer: (val) => val.toUpperCase() === '–ë–ò',
                        hint: '–î–≤–æ–∏—á–Ω—ã–π –∫–æ–¥ –ë—ç–∫–æ–Ω–∞'
                    }
                ]
            },
            
            // –≠–¢–ê–ü 4: –ü–û–î–í–ê–õ–¨–ù–´–ï –ü–û–ú–ï–©–ï–ù–ò–Ø
            chapter4: {
                ALFA: [
                    {
                        id: 'c4a1',
                        type: 'riddle',
                        title: '–õ–Æ–ö',
                        description: '–ê–≥–µ–Ω—Ç 1: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –æ—Ç–∫—Ä—ã–≤–∞—é –ø—É—Ç—å –≤–Ω–∏–∑, –Ω–æ —Å–∞–º –≤—Å–µ–≥–¥–∞ –Ω–∞–≤–µ—Ä—Ö—É. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–õ–Æ–ö', '–î–í–ï–†–¨', '–õ–ï–°–¢–ù–ò–¶–ê'].includes(val.toUpperCase()),
                        hint: '–í –ø–æ–ª—É –∏–ª–∏ –ø–æ—Ç–æ–ª–∫–µ',
                        player: 1
                    },
                    {
                        id: 'c4a2',
                        type: 'team_code',
                        title: '–ö–û–î –õ–Æ–ö–ê',
                        description: '–¢—è–∂—ë–ª—ã–π –º–µ—Ç–∞–ª–ª',
                        digits: ['5', '8', '2', '7'],
                        checkAnswer: (val) => val === '5827',
                        hint: '–¢—è–∂—ë–ª—ã–π –º–µ—Ç–∞–ª–ª'
                    },
                    {
                        id: 'c4a3',
                        type: 'scan',
                        title: '–ö–†–´–®–ö–ê –õ–Æ–ö–ê',
                        description: '–ù–∞ –∫—Ä—ã—à–∫–µ –ª—é–∫–∞',
                        code: 'ALFA_HATCH_4',
                        hint: '–ù–∞ –∫—Ä—ã—à–∫–µ –ª—é–∫–∞',
                        checkAnswer: (val) => val === 'ALFA_HATCH_4'
                    },
                    {
                        id: 'c4a4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 1,
                        checkAnswer: (val) => val === '–î–†–£–ñ–ë–ê'
                    },
                    {
                        id: 'c4a5',
                        type: 'cipher',
                        title: '–®–ò–§–† –ì–†–û–ù–°–§–ï–õ–¨–î–ê',
                        description: '–ö–ª—é—á: 123. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –î–ñ–ï',
                        checkAnswer: (val) => val.toUpperCase() === '–ë–ï–ì',
                        hint: '–°–¥–≤–∏–≥ –ø–æ —Ü–∏—Ñ—Ä–∞–º –∫–ª—é—á–∞'
                    }
                ],
                BRAVO: [
                    {
                        id: 'c4b1',
                        type: 'riddle',
                        title: '–¢–†–£–ë–ê',
                        description: '–ê–≥–µ–Ω—Ç 2: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø —Ç—è–Ω—É—Å—å –æ—Ç –ø–æ–ª–∞ –¥–æ –ø–æ—Ç–æ–ª–∫–∞, –Ω–æ –Ω–µ —Å—Ç–µ–Ω–∞. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–¢–†–£–ë–ê', '–¢–†–£–ë–û–ü–†–û–í–û–î'].includes(val.toUpperCase()),
                        hint: '–í–Ω—É—Ç—Ä–∏ —Ç–µ—á—ë—Ç –≤–æ–¥–∞ –∏–ª–∏ –ø–∞—Ä',
                        player: 2
                    },
                    {
                        id: 'c4b2',
                        type: 'team_binary',
                        title: '–ö–û–î –¢–†–£–ë–´',
                        description: '–î–≤–æ–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞',
                        binary: ['1101', '0011', '1010', '0111'],
                        checkAnswer: (val) => val === '1101001110100111',
                        hint: '–î–≤–æ–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞'
                    },
                    {
                        id: 'c4b3',
                        type: 'scan',
                        title: '–¢–†–£–ë–ê –û–¢–û–ü–õ–ï–ù–ò–Ø',
                        description: '–ù–∞ —Ç—Ä—É–±–µ –æ—Ç–æ–ø–ª–µ–Ω–∏—è',
                        code: 'BRAVO_PIPE_4',
                        hint: '–ù–∞ —Ç—Ä—É–±–µ –æ—Ç–æ–ø–ª–µ–Ω–∏—è',
                        checkAnswer: (val) => val === 'BRAVO_PIPE_4'
                    },
                    {
                        id: 'c4b4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 2,
                        checkAnswer: (val) => val === '–¢–û–í–ê–†–ò–©'
                    },
                    {
                        id: 'c4b5',
                        type: 'cipher',
                        title: '–®–ò—Ñ—Ä –•–ò–õ–õ–ê',
                        description: '–ú–∞—Ç—Ä–∏—Ü–∞ 2x2. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –ë–ì ‚Üí ?',
                        checkAnswer: (val) => val.toUpperCase() === '–ê–î',
                        hint: '–ú–∞—Ç—Ä–∏—á–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ'
                    }
                ],
                CHARLIE: [
                    {
                        id: 'c4c1',
                        type: 'riddle',
                        title: '–ö–ò–†–ü–ò–ß–ù–ê–Ø –°–¢–ï–ù–ê',
                        description: '–ê–≥–µ–Ω—Ç 3: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –∏–∑ –∫—Ä–∞—Å–Ω—ã—Ö –±–ª–æ–∫–æ–≤, –Ω–æ –Ω–µ –¥–æ–º. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–°–¢–ï–ù–ê', '–ö–õ–ê–î–¨', '–ü–û–ì–†–ï–ë'].includes(val.toUpperCase()),
                        hint: '–ü–æ–¥–∑–µ–º–Ω–∞—è —Å—Ç–µ–Ω–∞',
                        player: 3
                    },
                    {
                        id: 'c4c2',
                        type: 'team_morse',
                        title: '–°–ò–ì–ù–ê–õ –ò–ó –¢–ï–ú–ù–û–¢–´',
                        description: '–ü–æ–º–æ—â—å –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏',
                        morse: ['....', '.', '.-..', '.--.'],
                        checkAnswer: (val) => val.toUpperCase() === 'HELP',
                        hint: '–ü–æ–º–æ—â—å –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏'
                    },
                    {
                        id: 'c4c3',
                        type: 'scan',
                        title: '–í –°–¢–ï–ù–ï –ü–û–î–í–ê–õ–ê',
                        description: '–í —Å—Ç–µ–Ω–µ –ø–æ–¥–≤–∞–ª–∞',
                        code: 'CHARLIE_WALL_4',
                        hint: '–í —Å—Ç–µ–Ω–µ –ø–æ–¥–≤–∞–ª–∞',
                        checkAnswer: (val) => val === 'CHARLIE_WALL_4'
                    },
                    {
                        id: 'c4c4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 3,
                        checkAnswer: (val) => val === '–ï–î–ò–ù–°–¢–í–û'
                    },
                    {
                        id: 'c4c5',
                        type: 'cipher',
                        title: '–ê–§–§–ò–ù–ù–´–ô –®–ò–§–†',
                        description: '3x+7. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –ö (11 –±—É–∫–≤–∞)',
                        checkAnswer: (val) => val.toUpperCase() === '–ê',
                        hint: '–û–±—Ä–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: (y-7)/3'
                    }
                ],
                DELTA: [
                    {
                        id: 'c4d1',
                        type: 'riddle',
                        title: '–ü–û–¢–û–õ–û–ß–ù–ê–Ø –ë–ê–õ–ö–ê',
                        description: '–ê–≥–µ–Ω—Ç 4: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø –¥–µ—Ä–∂—É –≤—Å—ë –Ω–∞ —Å–µ–±–µ, –Ω–æ –Ω–µ –≤–∏–¥–Ω–∞ —Å–Ω–∏–∑—É. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–ë–ê–õ–ö–ê', '–ü–ï–†–ï–ö–†–´–¢–ò–ï'].includes(val.toUpperCase()),
                        hint: '–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ–ø–æ—Ä–∞',
                        player: 4
                    },
                    {
                        id: 'c4d2',
                        type: 'team_directions',
                        title: '–ü–£–¢–¨ –ö –í–´–•–û–î–£',
                        description: '–û–±—Ä–∞—Ç–Ω—ã–π –ø—É—Ç—å',
                        directions: ['–ù–ê–ü–†–ê–í–û', '–ü–†–Ø–ú–û', '–ù–ê–õ–ï–í–û', '–ü–†–Ø–ú–û'],
                        checkAnswer: (val) => val.toUpperCase() === '–ù–ê–ü–†–ê–í–û-–ü–†–Ø–ú–û-–ù–ê–õ–ï–í–û-–ü–†–Ø–ú–û',
                        hint: '–û–±—Ä–∞—Ç–Ω—ã–π –ø—É—Ç—å'
                    },
                    {
                        id: 'c4d3',
                        type: 'scan',
                        title: '–ó–ê–ü–ê–°–ù–û–ô –í–´–•–û–î',
                        description: '–£ –∑–∞–ø–∞—Å–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞',
                        code: 'DELTA_EXIT_4',
                        hint: '–£ –∑–∞–ø–∞—Å–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞',
                        checkAnswer: (val) => val === 'DELTA_EXIT_4'
                    },
                    {
                        id: 'c4d4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 4,
                        checkAnswer: (val) => val === '–°–û–î–†–£–ñ–ï–°–¢–í–û'
                    },
                    {
                        id: 'c4d5',
                        type: 'cipher',
                        title: '–®–ò–§–† –ü–õ–ï–ô–§–ï–†–ê',
                        description: '–ö–ª—é—á: –ú–£–ó–ï–ô. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: –ê–†–¢–£',
                        checkAnswer: (val) => val.toUpperCase() === '–ö–û–î–´',
                        hint: '–ü–æ —Ç–∞–±–ª–∏—Ü–µ 5x5'
                    }
                ],
                ECHO: [
                    {
                        id: 'c4e1',
                        type: 'riddle',
                        title: '–°–¢–ê–†–´–ô –°–ï–ô–§',
                        description: '–ê–≥–µ–Ω—Ç 1: –ß—Ç–æ —ç—Ç–æ?',
                        riddle: '–Ø —Ö—Ä–∞–Ω—é —Å–æ–∫—Ä–æ–≤–∏—â–∞ –∑–∞ —Ç–æ–ª—Å—Ç—ã–º–∏ —Å—Ç–µ–Ω–∫–∞–º–∏. –ß—Ç–æ —è?',
                        checkAnswer: (val) => ['–°–ï–ô–§', '–•–†–ê–ù–ò–õ–ò–©–ï'].includes(val.toUpperCase()),
                        hint: '–ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π —à–∫–∞—Ñ',
                        player: 1
                    },
                    {
                        id: 'c4e2',
                        type: 'team_rhythm',
                        title: '–°–¢–£–ö –í –¢–†–£–ë–ï',
                        description: '–ü—Ä–æ—Å—Ç–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
                        rhythm: ['–¢–£–ö', '–¢–£–ö-–¢–£–ö', '–¢–£–ö-–¢–£–ö-–¢–£–ö', '–¢–£–ö-–¢–£–ö-–¢–£–ö-–¢–£–ö'],
                        checkAnswer: (val) => val === '1-2-3-4',
                        hint: '–ü—Ä–æ—Å—Ç–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å'
                    },
                    {
                        id: 'c4e3',
                        type: 'scan',
                        title: '–î–í–ï–†–¨ –°–ï–ô–§–ê',
                        description: '–ù–∞ –¥–≤–µ—Ä–∏ —Å–µ–π—Ñ–∞',
                        code: 'ECHO_VAULT_4',
                        hint: '–ù–∞ –¥–≤–µ—Ä–∏ —Å–µ–π—Ñ–∞',
                        checkAnswer: (val) => val === 'ECHO_VAULT_4'
                    },
                    {
                        id: 'c4e4',
                        type: 'wordsearch20x20',
                        title: '–ë–û–õ–¨–®–ê–Ø –°–ï–¢–ö–ê –ë–£–ö–í',
                        description: '–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)',
                        hint: '–°–ª–æ–≤–æ —Å–ø—Ä—è—Ç–∞–Ω–æ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
                        teamId: 5,
                        checkAnswer: (val) => val === '–ë–†–ê–¢–°–¢–í–û'
                    },
                    {
                        id: 'c4e5',
                        type: 'cipher',
                        title: '–®–ò–§–† –í–ï–†–ù–ê–ú–ê',
                        description: 'XOR —Å –∫–ª—é—á–æ–º 1010. –†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ: 0110',
                        checkAnswer: (val) => val === '1100',
                        hint: '–ü–æ–±–∏—Ç–æ–≤–æ–µ –∏—Å–∫–ª—é—á–∞—é—â–µ–µ –ò–õ–ò'
                    }
                ]
            },
            
            // –≠–¢–ê–ü 5: –§–ò–ù–ê–õ - —Ç–æ–ª—å–∫–æ –∞–Ω–∞–≥—Ä–∞–º–º–∞, –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π
            chapter5: {
                ALFA: [],
                BRAVO: [],
                CHARLIE: [],
                DELTA: [],
                ECHO: []
            }
        };
        
        let currentMode = null;
        let myRoom = null;
        let myTeam = null;
        let myTeamId = null;
        let currentChapter = 0;
        let currentEvidenceIndex = 0;
        let qrScanner = null;
        let currentEvidence = null;
        let isAnswerChecked = false;
        let isScanning = false;
        let teamProgress = {
            completedChapters: []
        };
        let completedChapters = [];

        // ==================== INITIALIZATION ====================
        
        function startMode(mode) {
            if (!initFB()) return;
            currentMode = mode;
            document.getElementById('mode-select').classList.add('hidden');
            
            if (mode === 'teacher') {
                document.getElementById('teacher-panel').classList.remove('hidden');
                initTeacher();
            } else {
                document.getElementById('team-panel').classList.remove('hidden');
            }
        }

        // ==================== TEACHER FUNCTIONS ====================
        
        function initTeacher() {
            const existing = localStorage.getItem('museum_case');
            if (existing) {
                myRoom = existing;
                document.getElementById('room-code').textContent = myRoom;
                connectTeacher(myRoom);
            }
        }
        
        function createRoom() {
            myRoom = Math.floor(1000 + Math.random() * 9000).toString();
            localStorage.setItem('museum_case', myRoom);
            document.getElementById('room-code').textContent = myRoom;
            
            gameRef = db.ref('museumCases/' + myRoom);
            
            gameRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                chapter: 0,
                started: false,
                ended: false,
                timeLeft: 1200, // 20 minutes
                teams: {}
            }).then(() => {
                connectTeacher(myRoom);
                generateQRCodes();
            }).catch(err => {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            });
        }
        
        function deleteRoom() {
            if (myRoom && confirm('–ó–∞–∫—Ä—ã—Ç—å –¥–µ–ª–æ?')) {
                db.ref('museumCases/' + myRoom).remove();
                localStorage.removeItem('museum_case');
                location.reload();
            }
        }
        
        function connectTeacher(room) {
            gameRef = db.ref('museumCases/' + room);
            
            gameRef.on('value', (snap) => {
                const data = snap.val();
                if (!data) return;
                
                const teams = data.teams || {};
                document.getElementById('stat-teams').textContent = Object.keys(teams).length;
                document.getElementById('stat-phase').textContent = (data.chapter || 0) + '/5';
                
                const mins = Math.floor((data.timeLeft || 0) / 60);
                const secs = (data.timeLeft || 0) % 60;
                document.getElementById('stat-time').textContent =
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                const startBtn = document.getElementById('btn-start');
                if (Object.keys(teams).length > 0 && !data.started) {
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else if (data.started) {
                    startBtn.textContent = 'üîç –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û';
                    startBtn.disabled = true;
                }
                
                renderTeamsList(teams);
            });
            
            startGlobalTimer();
        }
        
        function startGlobalTimer() {
            if (globalTimerInterval) clearInterval(globalTimerInterval);
            
            globalTimerInterval = setInterval(() => {
                if (!gameRef) return;
                
                gameRef.once('value').then(snap => {
                    const data = snap.val();
                    if (data && data.started && !data.ended && data.timeLeft > 0) {
                        gameRef.update({ timeLeft: data.timeLeft - 1 });
                    }
                });
            }, 1000);
        }
        
        function renderTeamsList(teams) {
            const list = document.getElementById('teams-list');
            
            if (Object.keys(teams).length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8 italic">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø</div>';
                return;
            }
            
            list.innerHTML = Object.entries(teams).map(([id, team]) => {
                const info = TEAMS.find(t => t.id == id);
                const progress = team.progress || 0;
                const maxProgress = 25; // 5 —ç—Ç–∞–ø–æ–≤ –ø–æ 5 –∑–∞–¥–∞–Ω–∏–π
                
                return `
                    <div class="bg-black/40 rounded-lg p-4 border border-[#d4af37]/30 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl"
                             style="background: ${info.color}20; border: 2px solid ${info.color}">
                            ${info.emoji}
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-[#d4af37] font-title">${info.name}</div>
                            <div class="text-xs text-gray-400 mb-2">${(team.players || []).join(', ')}</div>
                            <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-[#d4af37] to-[#8b0000]"
                                     style="width: ${(progress/maxProgress)*100}%"></div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold" style="color: ${info.color}">${team.chapter || 0}</div>
                            <div class="text-xs text-gray-500">—ç—Ç–∞–ø</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function startGame() {
            if (!gameRef) return;
            
            gameRef.update({
                chapter: 1,
                started: true,
                startedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }
        
        function forcePhase(chapter) {
            if (!gameRef) return;
            gameRef.update({ chapter: chapter });
        }

        // Generate QR codes for printing
        function generateQRCodes() {
            const container = document.getElementById('qr-codes-container');
            container.innerHTML = '';
            
            const allCodes = [];
            
            // Collect all QR codes from evidence
            for (let chapter = 1; chapter <= 4; chapter++) {
                const chapterKey = 'chapter' + chapter;
                const chapterData = EVIDENCE[chapterKey];
                
                Object.keys(chapterData).forEach(teamName => {
                    chapterData[teamName].forEach(evidence => {
                        if (evidence.code) {
                            allCodes.push({
                                team: teamName,
                                chapter: chapter,
                                code: evidence.code,
                                title: evidence.title
                            });
                        }
                    });
                });
            }
            
            if (allCodes.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">–ù–µ—Ç QR-–∫–æ–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }
            
            // Generate QR codes using QRCode.js
            allCodes.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'qr-card';
                card.innerHTML = `
                    <div id="qrcode-${index}" class="qr-code-container"></div>
                    <div class="team-name">${item.team}</div>
                    <div class="chapter-num">–≠—Ç–∞–ø ${item.chapter}</div>
                    <div class="evidence-title">${item.title}</div>
                `;
                container.appendChild(card);
                
                // Generate QR code
                setTimeout(() => {
                    new QRCode(document.getElementById(`qrcode-${index}`), {
                        text: item.code,
                        width: 128,
                        height: 128,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }, 100);
            });
        }
        
        function printQRCodes() {
            const container = document.getElementById('qr-codes-container');
            if (!container || container.children.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –¥–µ–ª–æ!');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const codes = container.innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>QR-–∫–æ–¥—ã –¥–ª—è –ø–µ—á–∞—Ç–∏ - –ú—É–∑–µ–π–Ω–∞—è —Ç–∞–π–Ω–∞</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            background: #f5f5f5;
                        }
                        h1 {
                            text-align: center;
                            margin-bottom: 30px;
                            color: #1a1a2e;
                            font-family: 'Cinzel', serif;
                        }
                        .qr-display {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 20px;
                        }
                        .qr-card {
                            background: white;
                            border: 3px solid #d4af37;
                            padding: 15px;
                            text-align: center;
                            page-break-inside: avoid;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .qr-code-container {
                            width: 128px;
                            height: 128px;
                            margin: 0 auto 10px;
                        }
                        .qr-code-container img {
                            width: 100% !important;
                            height: 100% !important;
                        }
                        .team-name {
                            font-weight: bold;
                            font-size: 14px;
                            color: #1a1a2e;
                            margin-bottom: 5px;
                            text-transform: uppercase;
                        }
                        .chapter-num {
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        .evidence-title {
                            font-size: 11px;
                            color: #8b0000;
                            font-weight: bold;
                        }
                        .print-info {
                            text-align: center;
                            margin-top: 30px;
                            padding: 20px;
                            background: #1a1a2e;
                            color: #d4af37;
                            border-radius: 8px;
                        }
                        @media print {
                            body { background: white; }
                            .no-print { display: none !important; }
                            .qr-display { grid-template-columns: repeat(3, 1fr); gap: 15px; }
                            .qr-card { break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üîç QR-–∫–æ–¥—ã –¥–ª—è –∏–≥—Ä—ã "–ú—É–∑–µ–π–Ω–∞—è —Ç–∞–π–Ω–∞"</h1>
                    <div class="qr-display">${codes}</div>
                    <div class="print-info no-print">
                        <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –†–∞—Å–ø–µ—á–∞—Ç–∞–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ QR-–∫–æ–¥—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ª–æ–∫–∞—Ü–∏—è—Ö –º—É–∑–µ—è.</p>
                        <p>–ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ QR-–∫–æ–¥—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</p>
                        <button onclick="window.print()" style="margin-top: 15px; padding: 10px 30px; background: #d4af37; color: #1a1a2e; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }

        // ==================== TEAM FUNCTIONS ====================
        
        function selectTeam(num) {
            myTeamId = num;
            document.querySelectorAll('.team-btn').forEach(b => {
                b.style.opacity = '0.4';
                b.style.transform = 'scale(0.95)';
            });
            
            const selected = document.querySelector(`[data-t="${num}"]`);
            selected.style.opacity = '1';
            selected.style.transform = 'scale(1.05)';
            selected.style.borderWidth = '3px';
        }
        
        function joinGame() {
            const code = document.getElementById('join-code').value.trim();
            const err = document.getElementById('join-err');
            
            if (!code || code.length !== 4) {
                err.textContent = '–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –Ω–æ–º–µ—Ä –¥–µ–ª–∞';
                err.classList.remove('hidden');
                return;
            }
            if (!myTeamId) {
                err.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –≥—Ä—É–ø–ø—É';
                err.classList.remove('hidden');
                return;
            }
            
            const players = [
                document.getElementById('p1').value.trim(),
                document.getElementById('p2').value.trim(),
                document.getElementById('p3').value.trim(),
                document.getElementById('p4').value.trim()
            ].filter(p => p);
            
            if (players.length < 2) {
                err.textContent = '–ú–∏–Ω–∏–º—É–º 2 –∞–≥–µ–Ω—Ç–∞';
                err.classList.remove('hidden');
                return;
            }
            
            db.ref('museumCases/' + code).once('value').then(snap => {
                if (!snap.exists()) {
                    err.textContent = '–î–µ–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∞—Ä—Ö–∏–≤–µ';
                    err.classList.remove('hidden');
                    return;
                }
                
                const caseData = snap.val();
                if (caseData.teams && caseData.teams[myTeamId]) {
                    err.textContent = '–ì—Ä—É–ø–ø–∞ —É–∂–µ –≤ –¥–µ–ª–µ';
                    err.classList.remove('hidden');
                    return;
                }
                
                myRoom = code;
                myTeam = TEAMS.find(t => t.id === myTeamId);
                gameRef = db.ref('museumCases/' + code);
                
                return gameRef.child('teams/' + myTeamId).set({
                    players: players,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    chapter: 0,
                    currentEvidence: 0,
                    progress: 0,
                    completedEvidence: {},
                    completedChapters: []
                });
                
            }).then(() => {
                document.getElementById('team-connect').classList.add('hidden');
                document.getElementById('team-wait').classList.remove('hidden');
                
                document.getElementById('wait-team-emoji').textContent = myTeam.emoji;
                document.getElementById('wait-team-name').textContent = myTeam.name;
                document.getElementById('wait-team-name').style.color = myTeam.color;
                
                document.getElementById('wait-players').innerHTML = players.map((p, i) => `
                    <div class="flex items-center gap-3 p-2 bg-black/40 rounded border border-[#d4af37]/20">
                        <div class="player-role">${i+1}</div>
                        <span>${p}</span>
                    </div>
                `).join('');
                
                waitForStart();
                
            }).catch(e => {
                err.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
                err.classList.remove('hidden');
            });
        }
        
        function waitForStart() {
            gameRef.on('value', snap => {
                const data = snap.val();
                if (!data) return;
                
                // –ö–æ–≥–¥–∞ –∏–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
                if (data.started && !gameStartTime) {
                    gameStartTime = Date.now();
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä
                    startLocalTimer();
                }
                
                if (data.chapter > 0 && currentChapter === 0) {
                    currentChapter = data.chapter;
                    startTeamGame();
                }
                
                if (data.teams && data.teams[myTeamId]) {
                    const myData = data.teams[myTeamId];
                    
                    if (myData.chapter !== currentChapter) {
                        currentChapter = myData.chapter || 1;
                        loadChapter(currentChapter);
                    }
                    
                    if (myData.currentEvidence !== undefined && myData.currentEvidence !== currentEvidenceIndex) {
                        currentEvidenceIndex = myData.currentEvidence;
                        updateEvidenceBoard();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤
                    if (myData.completedChapters) {
                        completedChapters = myData.completedChapters;
                        updatePhaseButtons(completedChapters);
                    }
                }
            });
        }
        
        function updateTimerDisplay() {
            const mins = Math.floor(localTimeLeft / 60);
            const secs = localTimeLeft % 60;
            const timerEl = document.getElementById('game-timer');
            if (timerEl) {
                timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            const maxEvidence = 5;
            const totalEvidence = 20; // 4 —ç—Ç–∞–ø–∞ –ø–æ 5 –∑–∞–¥–∞–Ω–∏–π
            const completedEvidence = ((currentChapter - 1) * maxEvidence + currentEvidenceIndex);
            const progress = (completedEvidence / totalEvidence) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }
        
        function startTeamGame() {
            document.getElementById('team-wait').classList.add('hidden');
            document.getElementById('team-game').classList.remove('hidden');
            
            document.getElementById('game-team-name').textContent = myTeam.name;
            document.getElementById('game-team-name').style.color = myTeam.color;
            
            // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º
            if (!localTimerInterval) {
                startLocalTimer();
            }
            
            loadChapter(1);
        }
        
        function startLocalTimer() {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (localTimerInterval) clearInterval(localTimerInterval);
            
            lastTimerUpdate = Date.now();
            
            localTimerInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = Math.floor((now - lastTimerUpdate) / 1000);
                
                if (elapsed >= 1) {
                    localTimeLeft = Math.max(0, localTimeLeft - elapsed);
                    lastTimerUpdate = now;
                    updateTimerDisplay();
                    
                    // –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ
                    if (localTimeLeft <= 0) {
                        clearInterval(localTimerInterval);
                        alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ! –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.');
                    }
                }
            }, 1000);
        }
        
        function loadChapter(chapterNum) {
            currentChapter = chapterNum;
            const chapter = CHAPTERS[chapterNum - 1];
            
            document.body.className = `min-h-screen ${chapter.theme}`;
            
            document.getElementById('game-phase-num').textContent =
                ['I', 'II', 'III', 'IV', 'V'][chapterNum - 1];
            document.getElementById('phase-icon').textContent = chapter.icon;
            document.getElementById('phase-title').textContent = chapter.title;
            document.getElementById('phase-subtitle').textContent = chapter.subtitle;
            
            // –ï—Å–ª–∏ —ç—Ç–æ 5-–π —ç—Ç–∞–ø, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∞–Ω–∞–≥—Ä–∞–º–º—É
            if (chapterNum === 5) {
                showFinalAnagram();
            } else {
                gameRef.child('teams/' + myTeamId).once('value').then(snap => {
                    const teamData = snap.val();
                    if (teamData) {
                        currentEvidenceIndex = teamData.currentEvidence || 0;
                        updateEvidenceBoard();
                    }
                });
            }
        }
        
        function switchPhase(phaseNum) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —ç—Ç–æ—Ç —ç—Ç–∞–ø
            if (phaseNum === 5) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–π–¥–µ–Ω—ã –ª–∏ –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —ç—Ç–∞–ø—ã
                const allPrevCompleted = completedChapters.includes(1) &&
                                         completedChapters.includes(2) &&
                                         completedChapters.includes(3) &&
                                         completedChapters.includes(4);
                
                if (!allPrevCompleted) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ —ç—Ç–∞–ø—ã 1-4!');
                    return;
                }
            }
            
            if (phaseNum > currentChapter + 1 && phaseNum !== 5) return;
            
            loadChapter(phaseNum);
            
            document.querySelectorAll('.phase-btn').forEach((btn, idx) => {
                if (idx + 1 === phaseNum) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function updatePhaseButtons(completedChaptersList) {
            completedChapters = completedChaptersList || [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–π–¥–µ–Ω—ã –ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã 1-4
            const allPrevCompleted = completedChapters.includes(1) &&
                                     completedChapters.includes(2) &&
                                     completedChapters.includes(3) &&
                                     completedChapters.includes(4);
            
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`phase${i}-btn`);
                if (btn) {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
                    btn.classList.remove('completed', 'active', 'locked');
                    btn.disabled = false;
                    
                    if (completedChapters.includes(i)) {
                        btn.classList.add('completed');
                    }
                    
                    if (i === currentChapter) {
                        btn.classList.add('active');
                    }
                    
                    // –î–ª—è 5-–≥–æ —ç—Ç–∞–ø–∞: –±–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã 1-4
                    if (i === 5) {
                        if (!allPrevCompleted) {
                            btn.classList.add('locked');
                            btn.disabled = true;
                            btn.title = "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ —ç—Ç–∞–ø—ã 1-4";
                        } else {
                            btn.title = "–§–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø –¥–æ—Å—Ç—É–ø–µ–Ω";
                        }
                    }
                }
            }
        }
        
        function updateEvidenceBoard() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            const chapterKey = 'chapter' + currentChapter;
            const teamName = myTeam.name;
            const evidenceList = EVIDENCE[chapterKey][teamName] || [];
            
            // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —É–ª–∏–∫ –ø—É—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ 5-–º —ç—Ç–∞–ø–µ), –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            if (evidenceList.length === 0) {
                return;
            }
            
            evidenceList.forEach((evidence, index) => {
                const isLocked = index > currentEvidenceIndex;
                const isActive = index === currentEvidenceIndex;
                const isCompleted = index < currentEvidenceIndex;
                
                const card = document.createElement('div');
                card.className = `case-file rounded-lg p-6 mb-6 relative transition-all duration-500 ${
                    isLocked ? 'evidence-locked' : ''
                } ${isActive ? 'evidence-active' : ''} ${isCompleted ? 'card-completed' : ''}`;
                
                if (isActive) {
                    card.onclick = () => openEvidence(evidence);
                }
                
                const playerBadge = evidence.player ?
                    `<span class="inline-block bg-[#8b0000] text-white text-xs px-2 py-1 rounded ml-2">–ê–≥–µ–Ω—Ç ${evidence.player}</span>` : '';
                
                card.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-16 h-16 rounded-full bg-[#1a1a2e]/10 flex items-center justify-center text-3xl flex-shrink-0 border-2 border-[#d4af37]/30">
                            ${isCompleted ? '‚úì' : isLocked ? 'üîí' : getIcon(evidence.type)}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-title font-bold text-lg text-[#1a1a2e]">
                                    –£–õ–ò–ö–ê ${index + 1}: ${evidence.title}
                                    ${playerBadge}
                                </h4>
                            </div>
                            <p class="text-sm text-[#1a1a2e]/70 mb-3">${evidence.description}</p>
                            ${isCompleted ? '<div class="text-xs text-green-600 font-bold">‚úì –†–ê–°–°–õ–ï–î–û–í–ê–ù–û</div>' : ''}
                        </div>
                    </div>
                    ${isCompleted ? '<div class="stamp show">–†–ê–°–°–õ–ï–î–û–í–ê–ù–û</div>' : ''}
                `;
                
                container.appendChild(card);
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —É–ª–∏–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞ –ø—Ä–æ–π–¥–µ–Ω—ã
            if (currentEvidenceIndex >= evidenceList.length) {
                // –≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                showChapterComplete();
            }
        }
        
        function getIcon(type) {
            const icons = {
                'riddle': '‚ùì', 'team_equations': 'üìê', 'team_code': 'üî¢', 'team_binary': 'üíª',
                'team_morse': 'üì°', 'team_memory': 'üß†', 'team_directions': 'üß≠', 'team_shape': 'üî∑',
                'team_symbols': 'üî£', 'team_art': 'üé≠', 'team_numbers': 'üîü', 'team_rhythm': 'ü•Å',
                'scan': 'üì∑', 'puzzle': 'üß©', 'cipher': 'üîê', 'final': 'üèÜ', 'wordsearch': 'üîç',
                'wordsearch20x20': 'üîé'
            };
            return icons[type] || 'üìã';
        }
        
        function openEvidence(evidence) {
            currentEvidence = evidence;
            isAnswerChecked = false;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-overlay z-[150] flex items-center justify-center p-4';
            modal.id = 'evidence-modal';
            
            let content = renderEvidenceContent(evidence);
            
            modal.innerHTML = `
                <div class="case-file rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
                    <button onclick="closeEvidenceModal()" class="absolute top-4 right-4 text-[#1a1a2e] text-2xl hover:text-[#8b0000] transition">‚úï</button>
                    
                    <div class="mb-6">
                        <div class="text-xs text-[#8b0000] font-bold uppercase tracking-widest mb-2">–£–ª–∏–∫–∞ ${currentEvidenceIndex + 1}</div>
                        <h3 class="text-2xl font-title font-bold text-[#1a1a2e] mb-2">${evidence.title}</h3>
                        <p class="text-[#1a1a2e]/70 italic">${evidence.description}</p>
                    </div>
                    
                    <div class="bg-[#1a1a2e]/5 p-6 rounded-lg mb-6 border border-[#1a1a2e]/10">
                        ${content}
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="showHint('${evidence.hint}')" class="flex-1 btn-secondary-detective text-sm">
                            üí° –ü–û–î–°–ö–ê–ó–ö–ê
                        </button>
                        ${evidence.type !== 'scan' && evidence.type !== 'wordsearch' && evidence.type !== 'wordsearch20x20' ? `<button onclick="checkAnswer()" class="flex-1 btn-detective">‚úì –ü–†–û–í–ï–†–ò–¢–¨</button>` : ''}
                    </div>
                    
                    <div id="hint-box" class="hidden mt-4 p-4 bg-[#d4af37]/20 rounded border border-[#d4af37] text-sm text-[#1a1a2e]"></div>
                    <div id="error-box" class="hidden mt-4 p-4 bg-[#ff6b6b]/20 rounded border border-[#ff6b6b] text-sm text-[#8b0000] font-bold text-center"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function renderEvidenceContent(evidence) {
            switch(evidence.type) {
                case 'riddle':
                    return `
                        <div class="riddle-box mb-4">${evidence.riddle}</div>
                        <input type="text" id="answer-input" class="detective-input" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">
                    `;
                    
                case 'team_equations':
                    const equations = generateEquations(evidence.teamId);
                    return `
                        <div class="text-center mb-6">
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                ${equations.map((eq, i) => `
                                    <div class="bg-[#1a1a2e] text-[#d4af37] p-4 rounded text-center border-2 border-[#d4af37]">
                                        <div class="text-lg font-mono mb-2">${eq.eq}</div>
                                        <div class="text-xs text-gray-400">–ê–≥–µ–Ω—Ç ${i+1}</div>
                                        <div class="text-sm text-[#4ade80] mt-1">–û—Ç–≤–µ—Ç: ${eq.ans}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <p class="text-sm text-[#1a1a2e]/70 mb-4">–°–æ–µ–¥–∏–Ω–∏—Ç–µ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –≤ –æ–¥–∏–Ω –∫–æ–¥</p>
                            <input type="text" id="answer-input" class="detective-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ 4 —á–∏—Å–µ–ª...">
                        </div>
                    `;
                    
                case 'cipher':
                    return `
                        <div class="riddle-box mb-4 font-mono text-lg">${evidence.description}</div>
                        <input type="text" id="answer-input" class="detective-input" placeholder="–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ...">
                    `;
                    
                case 'team_code':
                    return `
                        <div class="text-center mb-6">
                            <div class="grid grid-cols-4 gap-4 mb-4">
                                ${evidence.digits.map((d, i) => `
                                    <div class="bg-[#1a1a2e] text-[#d4af37] p-4 rounded text-2xl font-bold font-mono border-2 border-[#d4af37]">
                                        ${d}
                                        <div class="text-xs mt-1 text-gray-400">–ê–≥–µ–Ω—Ç ${i+1}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="text" id="answer-input" class="detective-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ü–µ–ª–∏–∫–æ–º...">
                        </div>
                    `;
                    
                case 'team_colors':
                case 'team_directions':
                case 'team_shape':
                case 'team_symbols':
                case 'team_art':
                case 'team_numbers':
                    const items = evidence.colors || evidence.directions || evidence.shapes || evidence.symbols || evidence.colors || evidence.digits;
                    return `
                        <div class="text-center mb-6">
                            <div class="grid grid-cols-${items.length} gap-3 mb-4">
                                ${items.map((item, i) => `
                                    <div class="bg-[#1a1a2e] text-[#d4af37] p-4 rounded text-center border-2 border-[#d4af37]">
                                        <div class="text-2xl mb-1">${item}</div>
                                        <div class="text-xs text-gray-400">–ê–≥–µ–Ω—Ç ${i+1}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="text" id="answer-input" class="detective-input" placeholder="–°–æ–µ–¥–∏–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å...">
                        </div>
                    `;
                    
                case 'team_binary':
                    return `
                        <div class="text-center mb-6">
                            <div class="grid grid-cols-4 gap-3 mb-4">
                                ${evidence.binary.map((b, i) => `
                                    <div class="bg-[#1a1a2e] text-[#4ade80] p-4 rounded text-center border-2 border-[#d4af37] font-mono">
                                        <div class="text-lg">${b}</div>
                                        <div class="text-xs text-gray-400">–ê–≥–µ–Ω—Ç ${i+1}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="text" id="answer-input" class="detective-input" placeholder="–°–æ–µ–¥–∏–Ω–∏—Ç–µ –≤—Å–µ –≥—Ä—É–ø–ø—ã...">
                        </div>
                    `;
                    
                case 'team_morse':
                    return `
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-4 font-mono text-[#d4af37]">${evidence.morse.join(' ')}</div>
                            <input type="text" id="answer-input" class="detective-input" placeholder="–†–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ –ú–æ—Ä–∑–µ...">
                        </div>
                    `;
                    
                case 'team_rhythm':
                    return `
                        <div class="text-center mb-6">
                            <div class="riddle-box mb-4">
                                ${evidence.rhythm.join(' - ')}
                            </div>
                            <input type="text" id="answer-input" class="detective-input" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">
                        </div>
                    `;
                    
                case 'team_memory':
                    return `
                        <div class="text-center">
                            <div class="grid grid-cols-2 gap-3">
                                ${evidence.questions.map((q, i) => `
                                    <div class="p-3 bg-white rounded border border-[#d4af37]/30">
                                        <div class="text-xs text-[#1a1a2e]/60 mb-1">–ê–≥–µ–Ω—Ç ${q.player}</div>
                                        <div class="text-sm font-bold mb-2">${q.q}</div>
                                        <input type="text" id="mem-answer-${i}" class="w-full p-2 border border-[#d4af37] rounded text-sm" placeholder="–û—Ç–≤–µ—Ç...">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                case 'scan':
                    return `
                        <div class="text-center">
                            <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-[#1a1a2e]/10 flex items-center justify-center text-6xl border-4 border-[#d4af37]">
                                üì∑
                            </div>
                            <p class="mb-4 text-[#1a1a2e]/70">${evidence.hint}</p>
                            <button onclick="startQRScanner('${evidence.code}')" class="btn-detective w-full">
                                –û–¢–ö–†–´–¢–¨ –°–ö–ê–ù–ï–†
                            </button>
                        </div>
                    `;
                    
                case 'puzzle':
                    return `
                        <div class="text-center">
                            <div class="grid grid-cols-2 gap-4 mb-6 max-w-xs mx-auto">
                                ${[1,2,3,4].map(i => `
                                    <div class="puzzle-piece" id="puzzle-${i}" onclick="rotatePuzzle(${i})">
                                        ${i}
                                    </div>
                                `).join('')}
                            </div>
                            <p class="text-sm text-[#1a1a2e]/60 mb-4">–ù–∞–∂–∏–º–∞–π—Ç–µ, —á—Ç–æ–±—ã –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å</p>
                            <button onclick="completePuzzle()" class="btn-detective text-sm">–ì–û–¢–û–í–û</button>
                            <input type="hidden" id="answer-input" value="puzzle">
                        </div>
                    `;

                case 'wordsearch':
                    const wordData = generateWordSearch(evidence.teamId);
                    const grid = wordData.grid;
                    
                    let gridHtml = '<div class="word-grid">';
                    for (let row = 0; row < 7; row++) {
                        for (let col = 0; col < 7; col++) {
                            gridHtml += `<div class="grid-cell" data-row="${row}" data-col="${col}" onclick="selectGridCell(${row}, ${col})">${grid[row][col]}</div>`;
                        }
                    }
                    gridHtml += '</div>';
                    
                    return `
                        <div class="text-center">
                            <p class="mb-4 text-[#1a1a2e]">–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ, —Å–æ–µ–¥–∏–Ω—è—è –±—É–∫–≤—ã –ø–æ –ø–æ—Ä—è–¥–∫—É</p>
                            ${gridHtml}
                            <div class="mt-4">
                                <div class="selected-word" id="selected-word"></div>
                            </div>
                            <div class="flex gap-4 mt-4">
                                <button onclick="clearWordSelection()" class="btn-secondary-detective text-sm">–û–ß–ò–°–¢–ò–¢–¨</button>
                                <button onclick="checkWordSearch('${wordData.word}')" class="btn-detective text-sm">–ü–†–û–í–ï–†–ò–¢–¨</button>
                            </div>
                            <input type="hidden" id="answer-input">
                        </div>
                    `;

                case 'wordsearch20x20':
                    const wordData20x20 = generateWordSearch20x20(evidence.teamId);
                    const grid20x20 = wordData20x20.grid;
                    
                    let gridHtml20x20 = '<div class="word-grid-20x20" id="word-grid-20x20">';
                    // –î–æ–±–∞–≤–ª—è–µ–º SVG overlay –¥–ª—è –ª–∏–Ω–∏–π
                    gridHtml20x20 += '<svg class="word-line-overlay" id="word-line-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">';
                    gridHtml20x20 += '<line id="selection-line" class="word-line" x1="0" y1="0" x2="0" y2="0" />';
                    gridHtml20x20 += '</svg>';
                    
                    for (let row = 0; row < 20; row++) {
                        for (let col = 0; col < 20; col++) {
                            gridHtml20x20 += `<div class="grid-cell-20x20" data-row="${row}" data-col="${col}" onclick="selectGridCell20x20(${row}, ${col})">${grid20x20[row][col]}</div>`;
                        }
                    }
                    gridHtml20x20 += '</div>';
                    
                    return `
                        <div class="text-center">
                            <p class="mb-4 text-[#1a1a2e]">–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ —Å–µ—Ç–∫–µ 20x20 (–∏—â–∏—Ç–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏!)</p>
                            <p class="mb-2 text-sm text-[#8b0000]">–°–æ–µ–¥–∏–Ω—è–π—Ç–µ –±—É–∫–≤—ã –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –ª–∏–Ω–∏–µ–π</p>
                            ${gridHtml20x20}
                            <div class="mt-4">
                                <div class="selected-word-20x20" id="selected-word-20x20"></div>
                            </div>
                            <div class="flex gap-4 mt-4">
                                <button onclick="clearWordSelection20x20()" class="btn-secondary-detective text-sm">–û–ß–ò–°–¢–ò–¢–¨</button>
                                <button onclick="checkWordSearch20x20('${wordData20x20.word}')" class="btn-detective text-sm">–ü–†–û–í–ï–†–ò–¢–¨</button>
                            </div>
                            <input type="hidden" id="answer-input">
                        </div>
                    `;
                    
                case 'final':
                    return `<div class="text-center text-[#8b0000] font-bold">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∞–Ω–∞–≥—Ä–∞–º–º–µ</div>`;
                    
                default:
                    return `<div class="text-center">${evidence.description}</div>`;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–µ—Ç–∫–∏ 7x7
        let selectedCells = [];

        function selectGridCell(row, col) {
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            
            const existingIndex = selectedCells.findIndex(c => c.row === row && c.col === col);
            
            if (existingIndex !== -1) {
                if (existingIndex === selectedCells.length - 1) {
                    selectedCells.pop();
                    cell.classList.remove('selected');
                }
            } else {
                selectedCells.push({ row, col, letter: cell.textContent });
                cell.classList.add('selected');
            }
            
            updateSelectedWord();
        }

        function updateSelectedWord() {
            const word = selectedCells.map(c => c.letter).join('');
            document.getElementById('selected-word').textContent = word;
        }

        function clearWordSelection() {
            selectedCells.forEach(cell => {
                const el = document.querySelector(`[data-row="${cell.row}"][data-col="${cell.col}"]`);
                if (el) el.classList.remove('selected');
            });
            selectedCells = [];
            updateSelectedWord();
        }

        function checkWordSearch(correctWord) {
            const word = selectedCells.map(c => c.letter).join('');
            
            if (word === correctWord) {
                closeEvidenceModal();
                completeEvidence(true);
            } else {
                showError('–ù–µ–≤–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                clearWordSelection();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–µ—Ç–∫–∏ 20x20 —Å –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –∏ –ª–∏–Ω–∏–µ–π
        let selectedCells20x20 = [];
        let isDragging20x20 = false;
        let startCell20x20 = null;

        function selectGridCell20x20(row, col) {
            const cell = document.querySelector(`#word-grid-20x20 [data-row="${row}"][data-col="${col}"]`);
            
            // –ï—Å–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —è—á–µ–π–∫—É
            if (selectedCells20x20.length === 0) {
                selectedCells20x20.push({ row, col, letter: cell.textContent });
                cell.classList.add('selected');
                startCell20x20 = { row, col };
                updateSelectedWord20x20();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —è—á–µ–π–∫—É (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–º–µ–∂–Ω–æ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π)
            const last = selectedCells20x20[selectedCells20x20.length - 1];
            const rowDiff = row - last.row;
            const colDiff = col - last.col;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —è—á–µ–π–∫–∞ —Å–º–µ–∂–Ω–∞—è (–ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏, –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏–ª–∏ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)
            if (Math.abs(rowDiff) > 1 || Math.abs(colDiff) > 1) {
                showError('–ú–æ–∂–Ω–æ —Å–æ–µ–¥–∏–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ—Å–µ–¥–Ω–∏–µ –∫–ª–µ—Ç–∫–∏!');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ —è—á–µ–π–∫–∞
            const existingIndex = selectedCells20x20.findIndex(c => c.row === row && c.col === col);
            
            if (existingIndex !== -1) {
                // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –µ—ë —É–¥–∞–ª–∏—Ç—å
                if (existingIndex === selectedCells20x20.length - 1) {
                    selectedCells20x20.pop();
                    cell.classList.remove('selected');
                }
            } else {
                selectedCells20x20.push({ row, col, letter: cell.textContent });
                cell.classList.add('selected');
            }
            
            updateSelectedWord20x20();
            updateSelectionLine20x20();
        }

        function updateSelectedWord20x20() {
            const word = selectedCells20x20.map(c => c.letter).join('');
            document.getElementById('selected-word-20x20').textContent = word;
        }

        function updateSelectionLine20x20() {
            const line = document.getElementById('selection-line');
            if (!line || selectedCells20x20.length < 2) {
                if (line) line.classList.remove('show');
                return;
            }
            
            const first = selectedCells20x20[0];
            const last = selectedCells20x20[selectedCells20x20.length - 1];
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è SVG
            const grid = document.getElementById('word-grid-20x20');
            if (!grid) return;
            
            const cellSize = 100 / 20; // 20 —è—á–µ–µ–∫ –≤ —Å—Ç—Ä–æ–∫–µ
            
            const x1 = (first.col * cellSize) + (cellSize / 2);
            const y1 = (first.row * cellSize) + (cellSize / 2);
            const x2 = (last.col * cellSize) + (cellSize / 2);
            const y2 = (last.row * cellSize) + (cellSize / 2);
            
            line.setAttribute('x1', x1 + '%');
            line.setAttribute('y1', y1 + '%');
            line.setAttribute('x2', x2 + '%');
            line.setAttribute('y2', y2 + '%');
            line.classList.add('show');
        }

        function clearWordSelection20x20() {
            selectedCells20x20.forEach(cell => {
                const el = document.querySelector(`#word-grid-20x20 [data-row="${cell.row}"][data-col="${cell.col}"]`);
                if (el) el.classList.remove('selected');
            });
            selectedCells20x20 = [];
            updateSelectedWord20x20();
            
            const line = document.getElementById('selection-line');
            if (line) line.classList.remove('show');
        }

        function checkWordSearch20x20(correctWord) {
            const word = selectedCells20x20.map(c => c.letter).join('');
            
            if (word === correctWord) {
                closeEvidenceModal();
                completeEvidence(true);
            } else {
                showError('–ù–µ–≤–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                clearWordSelection20x20();
            }
        }
        
        function rotatePuzzle(id) {
            const piece = document.getElementById(`puzzle-${id}`);
            const currentRot = piece.style.transform || 'rotate(0deg)';
            const newRot = parseInt(currentRot.replace(/[^0-9-]/g, '')) + 90;
            piece.style.transform = `rotate(${newRot}deg)`;
        }
        
        function completePuzzle() {
            closeEvidenceModal();
            completeEvidence(true);
        }
        
        function startQRScanner(expectedCode) {
            document.getElementById('qr-modal').classList.remove('hidden');
            document.getElementById('qr-scanner-status').innerHTML = 'üîç –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...';
            
            if (isScanning) return;
            isScanning = true;
            
            if (!qrScanner) {
                qrScanner = new Html5Qrcode("qr-reader");
            }
            
            const qrConfig = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                rememberLastUsedCamera: true,
                aspectRatio: 1.0
            };
            
            qrScanner.start(
                { facingMode: "environment" },
                qrConfig,
                (decodedText) => {
                    if (decodedText === expectedCode) {
                        document.getElementById('qr-scanner-status').innerHTML = '‚úÖ –ö–æ–¥ –≤–µ—Ä–µ–Ω! –£–ª–∏–∫–∞ –Ω–∞–π–¥–µ–Ω–∞!';
                        
                        qrScanner.stop().then(() => {
                            isScanning = false;
                            setTimeout(() => {
                                closeQR();
                                closeEvidenceModal();
                                completeEvidence(true);
                            }, 1000);
                        }).catch(() => {
                            isScanning = false;
                        });
                    } else {
                        document.getElementById('qr-scanner-status').innerHTML = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.';
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º pause/resume –≤–º–µ—Å—Ç–æ stop/start
                        qrScanner.pause();
                        setTimeout(() => {
                            qrScanner.resume();
                            document.getElementById('qr-scanner-status').innerHTML = 'üîç –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Å–Ω–æ–≤–∞...';
                        }, 2000);
                    }
                },
                (error) => {
                    if (!error.includes('NotFoundException')) {
                        console.log('QR Scan error:', error);
                    }
                }
            ).catch(err => {
                console.error('QR Scanner start error:', err);
                isScanning = false;
                closeQR();
                
                const code = prompt('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é:');
                if (code === expectedCode) {
                    closeEvidenceModal();
                    completeEvidence(true);
                } else if (code) {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!');
                }
            });
        }
        
        function closeQR() {
            document.getElementById('qr-modal').classList.add('hidden');
            if (qrScanner && isScanning) {
                qrScanner.stop().catch(() => {});
                isScanning = false;
            }
        }
        
        function closeEvidenceModal() {
            const modal = document.getElementById('evidence-modal');
            if (modal) modal.remove();
        }
        
        function showHint(hint) {
            const box = document.getElementById('hint-box');
            box.textContent = 'üí° ' + hint;
            box.classList.remove('hidden');
        }
        
        function showError(msg) {
            const box = document.getElementById('error-box');
            box.textContent = '‚ùå ' + msg;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }
        
        function checkAnswer() {
            if (!currentEvidence) return;
            if (isAnswerChecked) return;
            
            let userAnswer;
            
            if (currentEvidence.type === 'team_memory') {
                const answers = [];
                for (let i = 0; i < currentEvidence.questions.length; i++) {
                    const val = document.getElementById(`mem-answer-${i}`)?.value;
                    if (!val || val.trim() === '') {
                        showError('–í—Å–µ –∞–≥–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–≤–µ—Ç–∏—Ç—å!');
                        return;
                    }
                    answers.push(val);
                }
                userAnswer = answers;
            } else {
                const input = document.getElementById('answer-input');
                if (!input) {
                    if (currentEvidence.type === 'puzzle') return;
                    showError('–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞!');
                    return;
                }
                userAnswer = input.value.trim();
                if (!userAnswer && currentEvidence.type !== 'puzzle') {
                    showError('–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç!');
                    return;
                }
            }
            
            const isCorrect = currentEvidence.checkAnswer(userAnswer);
            
            if (isCorrect) {
                isAnswerChecked = true;
                closeEvidenceModal();
                completeEvidence(true);
            } else {
                showError('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                const modal = document.getElementById('evidence-modal');
                if (modal) modal.classList.add('shake');
                setTimeout(() => modal?.classList.remove('shake'), 500);
            }
        }
        
        function completeEvidence(success) {
            if (!gameRef) return;
            
            gameRef.child('teams/' + myTeamId).transaction(teamData => {
                if (!teamData) return teamData;
                
                if (currentEvidenceIndex === (teamData.currentEvidence || 0)) {
                    teamData.currentEvidence = (teamData.currentEvidence || 0) + 1;
                    teamData.progress = (teamData.progress || 0) + (success ? 1 : 0);
                }
                
                if (!teamData.completedEvidence) teamData.completedEvidence = {};
                teamData.completedEvidence[currentEvidenceIndex] = success;
                
                return teamData;
            }).then(() => {
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ —ç—Ç–∞–ø
                const chapterKey = 'chapter' + currentChapter;
                const teamName = myTeam.name;
                const evidenceList = EVIDENCE[chapterKey][teamName] || [];
                
                // –ï—Å–ª–∏ –≤—Å–µ —É–ª–∏–∫–∏ —ç—Ç–∞–ø–∞ –ø—Ä–æ–π–¥–µ–Ω—ã, –æ—Ç–º–µ—á–∞–µ–º —ç—Ç–∞–ø –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
                if (currentEvidenceIndex + 1 >= evidenceList.length) {
                    markChapterComplete();
                }
            });
        }
        
        function markChapterComplete() {
            if (!gameRef) return;
            
            gameRef.child('teams/' + myTeamId).transaction(teamData => {
                if (!teamData) return teamData;
                
                if (!teamData.completedChapters) teamData.completedChapters = [];
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –≤ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                if (!teamData.completedChapters.includes(currentChapter)) {
                    teamData.completedChapters.push(currentChapter);
                }
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ 4-–π —ç—Ç–∞–ø
                // (4-–π —ç—Ç–∞–ø –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ 5-–π —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π)
                if (currentChapter < 4) {
                    teamData.chapter = currentChapter + 1;
                    teamData.currentEvidence = 0;
                }
                
                return teamData;
            }).then(() => {
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                showChapterComplete();
            });
        }
        
        function showChapterComplete() {
            const container = document.getElementById('cards-container');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–∫–∞–∑–∞–Ω–æ –ª–∏ —É–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
            if (document.getElementById('chapter-complete-message')) return;
            
            const div = document.createElement('div');
            div.id = 'chapter-complete-message';
            div.className = 'case-file rounded-lg p-8 text-center mt-4';
            div.innerHTML = `
                <div class="text-6xl mb-4">üìÅ</div>
                <h3 class="text-2xl font-title font-bold text-[#1a1a2e] mb-4">–≠–¢–ê–ü ${currentChapter} –ó–ê–í–ï–†–®–Å–ù</h3>
                <p class="text-[#1a1a2e]/70 mb-6">–í—Å–µ —É–ª–∏–∫–∏ —Å–æ–±—Ä–∞–Ω—ã.</p>
                ${currentChapter < 4 ? `
                    <button onclick="goToNextChapter()" class="btn-detective mb-4">
                        –ü–ï–†–ï–ô–¢–ò –ö –≠–¢–ê–ü–£ ${currentChapter + 1} ‚Üí
                    </button>
                ` : currentChapter === 4 ? `
                    <p class="text-sm text-[#8b0000] animate-pulse mb-4">–í—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–π–¥–µ–Ω—ã! –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–µ–π—Ñ (—ç—Ç–∞–ø 5).</p>
                    <button onclick="goToFinalChapter()" class="btn-detective">
                        –û–¢–ö–†–´–¢–¨ –§–ò–ù–ê–õ–¨–ù–´–ô –°–ï–ô–§ üîê
                    </button>
                ` : ''}
            `;
            
            container.appendChild(div);
        }
        
        function goToNextChapter() {
            const nextChapter = currentChapter + 1;
            
            gameRef.child('teams/' + myTeamId).update({
                chapter: nextChapter,
                currentEvidence: 0
            }).then(() => {
                loadChapter(nextChapter);
            });
        }
        
        function goToFinalChapter() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–π–¥–µ–Ω—ã –ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã 1-4
            const allPrevCompleted = completedChapters.includes(1) &&
                                     completedChapters.includes(2) &&
                                     completedChapters.includes(3) &&
                                     completedChapters.includes(4);
            
            if (!allPrevCompleted) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ —ç—Ç–∞–ø—ã 1-4!');
                return;
            }
            
            gameRef.child('teams/' + myTeamId).update({
                chapter: 5,
                currentEvidence: 0
            }).then(() => {
                loadChapter(5);
            });
        }
        
        function showFinalAnagram() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            const letters = myTeam.letters.split('');
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –±—É–∫–≤—ã –¥–ª—è –∞–Ω–∞–≥—Ä–∞–º–º—ã
            const shuffledLetters = [...letters].sort(() => Math.random() - 0.5);
            
            const div = document.createElement('div');
            div.className = 'case-file rounded-lg p-8';
            div.innerHTML = `
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üîê</div>
                    <h3 class="text-3xl font-title font-bold text-[#1a1a2e] mb-2">–§–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î</h3>
                    <p class="text-[#1a1a2e]/70 mb-4">–°–æ–±–µ—Ä–∏—Ç–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –∏–∑ –±—É–∫–≤</p>
                    <p class="text-sm text-[#8b0000] italic">"${myTeam.hint}"</p>
                </div>
                
                <div class="flex flex-wrap justify-center gap-3 mb-8">
                    ${shuffledLetters.map((l, i) => `
                        <button onclick="pickLetter('${l}', ${i})" id="letter-${i}"
                                class="anagram-tile">
                            ${l}
                        </button>
                    `).join('')}
                </div>
                
                <div class="bg-[#1a1a2e]/5 rounded-lg p-6 mb-6 border-2 border-[#d4af37]">
                    <div class="text-xs text-[#1a1a2e]/60 uppercase mb-2 tracking-widest">–í–∞—à –∫–æ–¥:</div>
                    <div id="word-display" class="text-4xl font-mono font-bold text-[#1a1a2e] tracking-[0.3em] text-center min-h-[60px]"></div>
                </div>
                
                <div class="flex gap-4">
                    <button onclick="clearWord()" class="flex-1 btn-secondary-detective">‚Ü∫ –°–ë–†–û–°</button>
                    <button onclick="checkFinalAnagram()" class="flex-1 btn-detective">üîì –û–¢–ü–ï–†–ï–¢–¨</button>
                </div>
                
                <div id="final-error" class="hidden mt-4 p-4 bg-[#ff6b6b]/20 rounded border border-[#ff6b6b] text-[#8b0000] text-center font-bold"></div>
            `;
            
            container.appendChild(div);
            
            window.anagramState = {
                available: shuffledLetters.map((l, i) => ({ letter: l, index: i })),
                selected: []
            };
        }
        
        function pickLetter(letter, index) {
            const state = window.anagramState;
            const availableIndex = state.available.findIndex(a => a.index === index);
            if (availableIndex === -1) return;
            
            state.selected.push(state.available[availableIndex]);
            state.available.splice(availableIndex, 1);
            
            document.getElementById(`letter-${index}`).classList.add('used');
            
            updateWordDisplay();
        }
        
        function updateWordDisplay() {
            const word = window.anagramState.selected.map(s => s.letter).join('');
            document.getElementById('word-display').textContent = word;
        }
        
        function clearWord() {
            const state = window.anagramState;
            state.selected.forEach(s => {
                document.getElementById(`letter-${s.index}`).classList.remove('used');
            });
            state.available = [...state.selected, ...state.available].sort((a, b) => a.index - b.index);
            state.selected = [];
            updateWordDisplay();
            document.getElementById('final-error').classList.add('hidden');
        }
        
        function checkFinalAnagram() {
            const word = window.anagramState.selected.map(s => s.letter).join('');
            
            const finalEvidence = {
                checkAnswer: (val) => val === myTeam.anagram
            };
            
            if (finalEvidence.checkAnswer(word)) {
                gameRef.child('teams/' + myTeamId).update({
                    finished: true,
                    finishedAt: firebase.database.ServerValue.TIMESTAMP
                });
                showVictory();
            } else {
                const err = document.getElementById('final-error');
                err.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ!';
                err.classList.remove('hidden');
                
                const display = document.getElementById('word-display');
                display.style.color = '#8b0000';
                setTimeout(() => display.style.color = '', 600);
            }
        }
        
        function showVictory() {
            document.getElementById('victory-modal').classList.remove('hidden');
            document.getElementById('vic-team').textContent = myTeam.name;
            document.getElementById('vic-team').style.color = myTeam.color;
            document.getElementById('vic-word').textContent = myTeam.anagram;
            
            if (localTimerInterval) clearInterval(localTimerInterval);
        }
        
        window.onload = () => {};
    </script>
</body>
</html>
